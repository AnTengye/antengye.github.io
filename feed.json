{
    "version": "https://jsonfeed.org/version/1",
    "title": "Antengye's Blog",
    "description": "记录的本质是为了更高效地生活，分享的本质是什么呢？",
    "home_page_url": "https://bigorange.work",
    "items": [
        {
            "id": "https://bigorange.work/p/88ab7236/",
            "url": "https://bigorange.work/p/88ab7236/",
            "title": "在阿里云搭建无域名的tailscale的Derp服务",
            "date_published": "2025-01-10T06:05:33.000Z",
            "content_html": "<p>书接 (Tailscale 组网记录)[./22f71dfd]</p>\n<h2 id=\"为什么需要derp服务\"><a class=\"markdownIt-Anchor\" href=\"#为什么需要derp服务\">#</a> 为什么需要 Derp 服务</h2>\n<p>这是由于 Tailscale 机制决定的。</p>\n<p>tailscale 只会在需要与 peer 建立连接的时候才会尝试打洞，而且最开始的流量一定是会经过 DERP 中转服务器。</p>\n<p>优点：懒加载机制无需预先维护与其他节点的任何打洞连接，无需预先维护任何状态。</p>\n<p>缺点：每次通过 tailscale 创建虚拟连接时，初始所创建的连接其延迟很高，这会极大的影响使用体验；tailscale 极其依赖中继节点。</p>\n<p>当然官方是有提供默认的一系列 Derp 服务器，可以通过 <code>tailscale netcheck</code>  来查看</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">Report:</span><br><span class=\"line\">        * UDP: <span class=\"literal\">true</span></span><br><span class=\"line\">        * IPv4: <span class=\"built_in\">yes</span>, xxxx</span><br><span class=\"line\">        * IPv6: no, but OS has support</span><br><span class=\"line\">        * MappingVariesByDestIP: <span class=\"literal\">true</span></span><br><span class=\"line\">        * HairPinning: <span class=\"literal\">false</span></span><br><span class=\"line\">        * PortMapping:</span><br><span class=\"line\">        * CaptivePortal: <span class=\"literal\">false</span></span><br><span class=\"line\">        * Nearest DERP: lax</span><br><span class=\"line\">        * DERP latency:</span><br><span class=\"line\">                - lax: 165.8ms (Los Angeles)</span><br><span class=\"line\">                - sfo: 173ms   (San Francisco)</span><br><span class=\"line\">                - tok: 173.8ms (Tokyo)</span><br><span class=\"line\">                - sea: 175.6ms (Seattle)</span><br><span class=\"line\">                - den: 181.5ms (Denver)</span><br><span class=\"line\">                - dfw: 184.1ms (Dallas)</span><br><span class=\"line\">                - ord: 200.7ms (Chicago)</span><br><span class=\"line\">                - hkg: 207.5ms (Hong Kong)</span><br><span class=\"line\">                - hnl: 209ms   (Honolulu)</span><br><span class=\"line\">                - nyc: 213.5ms (New York City)</span><br><span class=\"line\">                - mia: 220.6ms (Miami)</span><br><span class=\"line\">                - iad: 223.6ms (Ashburn)</span><br><span class=\"line\">                - par: 229ms   (Paris)</span><br><span class=\"line\">                - lhr: 230.2ms (London)</span><br><span class=\"line\">                - tor: 231.1ms (Toronto)</span><br><span class=\"line\">                - sin: 234.8ms (Singapore)</span><br><span class=\"line\">                - fra: 238.3ms (Frankfurt)</span><br><span class=\"line\">                - ams: 248.9ms (Amsterdam)</span><br><span class=\"line\">                - nue: 253.4ms (Nuremberg)</span><br><span class=\"line\">                - mad: 266.3ms (Madrid)</span><br><span class=\"line\">                - waw: 266.6ms (Warsaw)</span><br><span class=\"line\">                - blr: 271.1ms (Bangalore)</span><br><span class=\"line\">                - syd: 322ms   (Sydney)</span><br><span class=\"line\">                - sao: 330.8ms (São Paulo)</span><br><span class=\"line\">                - dbi: 348.1ms (Dubai)</span><br><span class=\"line\">                - jnb: 384.2ms (Johannesburg)</span><br><span class=\"line\">                - nai: 393.9ms (Nairobi)</span><br></pre></td></tr></table></figure>\n<p>可以看到基本上都是国外的服务器，这也就意味着，如果打洞失败，走 derp 服务器中转的话，会导致延迟非常之高。</p>\n<h2 id=\"搭建derp服务\"><a class=\"markdownIt-Anchor\" href=\"#搭建derp服务\">#</a> 搭建 Derp 服务</h2>\n<p>本次搭建教程不基于网上的 Docker 版本，是基于官网的文档来进行搭建的。</p>\n<h3 id=\"环境准备\"><a class=\"markdownIt-Anchor\" href=\"#环境准备\">#</a> 环境准备</h3>\n<p>基于 Tailscale 官方提供的<a href=\"https://tailscale.com/kb/1118/custom-derp-servers#why-run-your-own-derp-server\">文档</a></p>\n<p>以下为一些硬性要求：</p>\n<ul>\n<li>\n<p>需要能够公网访问。这是为了让各个 Tailscale 节点可以直接访问到该 DERP 服务器</p>\n</li>\n<li>\n<p>需要运行 HTTPS 服务。本质上是为了在传输数据给 DERP 服务器时数据可以通过 TLS 加密。</p>\n</li>\n<li>\n<p>分配 80 端口来运行 HTTP 服务。</p>\n</li>\n<li>\n<p>需要额外暴露两个端口来运行 HTTPS 和 STUN 服务。</p>\n</li>\n<li>\n<p>必须允许 ICMP 流量的出入。</p>\n</li>\n</ul>\n<h3 id=\"官方安装\"><a class=\"markdownIt-Anchor\" href=\"#官方安装\">#</a> 官方安装</h3>\n<p>官方提供的安装步骤就两步</p>\n<ol>\n<li>安装 Derper 程序</li>\n</ol>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">go install tailscale.com/cmd/derper@latest</span><br></pre></td></tr></table></figure>\n<ol start=\"2\">\n<li>运行 Derper</li>\n</ol>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">sudo derper --hostname=your-hostname.com</span><br></pre></td></tr></table></figure>\n<h3 id=\"安装运行依赖\"><a class=\"markdownIt-Anchor\" href=\"#安装运行依赖\">#</a> 安装运行依赖</h3>\n<p>当然大多数干净的系统执行第一步就会执行不下去，这个是需要依赖 Go 环境，而 tailscale 的 Go 版本总是会依赖最新的 Go。</p>\n<p>以下提供当前的 <code>go 1.23.4</code>  的安装，其他版本或者更新的版本可以到 Go 官网下载安装：<a href=\"https://go.dev/doc/install\">https://go.dev/doc/install</a></p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">wget https://go.dev/dl/go1.23.4.linux-amd64.tar.gz</span><br><span class=\"line\"><span class=\"built_in\">rm</span> -rf /usr/local/go &amp;&amp; tar -C /usr/local -xzf go1.23.4.linux-amd64.tar.gz</span><br><span class=\"line\"><span class=\"built_in\">export</span> PATH=<span class=\"variable\">$PATH</span>:/usr/local/go/bin</span><br><span class=\"line\">go version</span><br><span class=\"line\">go <span class=\"built_in\">env</span> -w GOPROXY=https://goproxy.cn,direct</span><br></pre></td></tr></table></figure>\n<blockquote>\n<p>Note: Changes made to a profile file may not apply until the next time you log into your computer. To apply the changes immediately, just run the shell commands directly or execute them from the profile using a command such as source $HOME/.profile.</p>\n</blockquote>\n<p>上面执行完，就安装好了 Go 环境，同时指定了 Go 代理地址，因为阿里云服务器下载 github 包大概率会失败。</p>\n<h3 id=\"用ip代替域名的原理技术细节可以不看\"><a class=\"markdownIt-Anchor\" href=\"#用ip代替域名的原理技术细节可以不看\">#</a> 用 IP 代替域名的原理（技术细节，可以不看）</h3>\n<p>因为 Derper 需要指定证书，并且验证证书，因此需要一个域名来启动 Derper。</p>\n<p>而看到很多博主教程中是修改了 Derper 的源码后重新编译来跳过域名验证，从而实现 IP 启动。</p>\n<p>我看了下 Derper 的源码，发现新版本中并不需要这样处理了。</p>\n<figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"params\">(m *manualCertManager)</span></span> getCertificate(hi *tls.ClientHelloInfo) (*tls.Certificate, <span class=\"type\">error</span>) &#123;</span><br><span class=\"line\">\t<span class=\"keyword\">if</span> hi.ServerName != m.hostname &amp;&amp; !m.noHostname &#123;</span><br><span class=\"line\">\t\t<span class=\"keyword\">return</span> <span class=\"literal\">nil</span>, fmt.Errorf(<span class=\"string\">&quot;cert mismatch with hostname: %q&quot;</span>, hi.ServerName)</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"comment\">// Return a shallow copy of the cert so the caller can append to its</span></span><br><span class=\"line\">\t<span class=\"comment\">// Certificate field.</span></span><br><span class=\"line\">\tcertCopy := <span class=\"built_in\">new</span>(tls.Certificate)</span><br><span class=\"line\">\t*certCopy = *m.cert</span><br><span class=\"line\">\tcertCopy.Certificate = certCopy.Certificate[:<span class=\"built_in\">len</span>(certCopy.Certificate):<span class=\"built_in\">len</span>(certCopy.Certificate)]</span><br><span class=\"line\">\t<span class=\"keyword\">return</span> certCopy, <span class=\"literal\">nil</span></span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>Derper 源码中新增了  <code>&amp;&amp; !m.noHostname</code>  这样的一个逻辑判断可以绕过域名的检测。</p>\n<p>而这个 <code>noHostname</code>  参数则是在前面运行的 hostname 指定的 <code>derper --hostname=your-hostname.com</code></p>\n<figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">if</span> err := x509Cert.VerifyHostname(hostname); err != <span class=\"literal\">nil</span> &#123;</span><br><span class=\"line\">\t<span class=\"keyword\">return</span> <span class=\"literal\">nil</span>, fmt.Errorf(<span class=\"string\">&quot;cert invalid for hostname %q: %w&quot;</span>, hostname, err)</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"keyword\">return</span> &amp;manualCertManager&#123;</span><br><span class=\"line\">\tcert:       &amp;cert,</span><br><span class=\"line\">\thostname:   hostname,</span><br><span class=\"line\">\tnoHostname: net.ParseIP(hostname) != <span class=\"literal\">nil</span>,</span><br><span class=\"line\">&#125;, <span class=\"literal\">nil</span></span><br></pre></td></tr></table></figure>\n<p>也就是说，只要我们提供的证书能够通过 <code>x509Cert.VerifyHostname</code>  那么我们就能直接传一个 IP 作为 <code>hostname</code></p>\n<h3 id=\"用ip代替域名\"><a class=\"markdownIt-Anchor\" href=\"#用ip代替域名\">#</a> 用 IP 代替域名</h3>\n<p>只要用 IP 生成一个自签名证书即可，如果直接尝试 <code>openssl x509</code>  可不太行。</p>\n<p>需要将 IP 地址作为证书的 Subject Alternative Name (SAN) 添加到证书中。</p>\n<p>因为前面已经安装了 Go 的运行环境了，所以我这里提供一个 Go 版本的生成方案</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">mkdir -p ~/certdir</span><br><span class=\"line\">cd ~/certdir</span><br></pre></td></tr></table></figure>\n<p>将下面这段代码复制， 然后 <code>vim main.go</code>  粘贴后改成你的 IP 保存。</p>\n<figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">package</span> main</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">import</span> (</span><br><span class=\"line\">\t<span class=\"string\">&quot;crypto/ecdsa&quot;</span></span><br><span class=\"line\">\t<span class=\"string\">&quot;crypto/elliptic&quot;</span></span><br><span class=\"line\">\t<span class=\"string\">&quot;crypto/rand&quot;</span></span><br><span class=\"line\">\t<span class=\"string\">&quot;crypto/x509&quot;</span></span><br><span class=\"line\">\t<span class=\"string\">&quot;crypto/x509/pkix&quot;</span></span><br><span class=\"line\">\t<span class=\"string\">&quot;encoding/pem&quot;</span></span><br><span class=\"line\">\t<span class=\"string\">&quot;fmt&quot;</span></span><br><span class=\"line\">\t<span class=\"string\">&quot;log&quot;</span></span><br><span class=\"line\">\t<span class=\"string\">&quot;math/big&quot;</span></span><br><span class=\"line\">\t<span class=\"string\">&quot;net&quot;</span></span><br><span class=\"line\">\t<span class=\"string\">&quot;os&quot;</span></span><br><span class=\"line\">\t<span class=\"string\">&quot;time&quot;</span></span><br><span class=\"line\">)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"title\">main</span><span class=\"params\">()</span></span> &#123;</span><br><span class=\"line\">\t<span class=\"comment\">// IP地址，替换为你自己的服务器实际IP</span></span><br><span class=\"line\">\tip := <span class=\"string\">&quot;127.0.0.1&quot;</span></span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"comment\">// 生成密钥对</span></span><br><span class=\"line\">\tpriv, err := ecdsa.GenerateKey(elliptic.P384(), rand.Reader)</span><br><span class=\"line\">\t<span class=\"keyword\">if</span> err != <span class=\"literal\">nil</span> &#123;</span><br><span class=\"line\">\t\tlog.Fatalf(<span class=\"string\">&quot;Failed to generate private key: %v&quot;</span>, err)</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"comment\">// 生成证书模板</span></span><br><span class=\"line\">\ttemplate := x509.Certificate&#123;</span><br><span class=\"line\">\t\tSerialNumber:          big.NewInt(<span class=\"number\">12345</span>),</span><br><span class=\"line\">\t\tSubject:               pkix.Name&#123;Organization: []<span class=\"type\">string</span>&#123;<span class=\"string\">&quot;Example Org&quot;</span>&#125;&#125;,</span><br><span class=\"line\">\t\tNotBefore:             time.Now(),</span><br><span class=\"line\">\t\tNotAfter:              time.Now().Add(<span class=\"number\">365</span> * <span class=\"number\">24</span> * time.Hour * <span class=\"number\">100</span>),</span><br><span class=\"line\">\t\tKeyUsage:              x509.KeyUsageKeyEncipherment | x509.KeyUsageDigitalSignature,</span><br><span class=\"line\">\t\tExtKeyUsage:           []x509.ExtKeyUsage&#123;x509.ExtKeyUsageServerAuth&#125;,</span><br><span class=\"line\">\t\tBasicConstraintsValid: <span class=\"literal\">true</span>,</span><br><span class=\"line\">\t\tDNSNames:              []<span class=\"type\">string</span>&#123;ip&#125;,</span><br><span class=\"line\">\t\tIPAddresses:           []net.IP&#123;net.ParseIP(ip)&#125;, <span class=\"comment\">// 指定 IP 地址</span></span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"comment\">// 使用私钥签发证书</span></span><br><span class=\"line\">\tcertDER, err := x509.CreateCertificate(rand.Reader, &amp;template, &amp;template, &amp;priv.PublicKey, priv)</span><br><span class=\"line\">\t<span class=\"keyword\">if</span> err != <span class=\"literal\">nil</span> &#123;</span><br><span class=\"line\">\t\tlog.Fatalf(<span class=\"string\">&quot;Failed to create certificate: %v&quot;</span>, err)</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"comment\">// 保存证书文件</span></span><br><span class=\"line\">\tcertFile, err := os.Create(fmt.Sprintf(<span class=\"string\">&quot;%s.crt&quot;</span>, ip))</span><br><span class=\"line\">\t<span class=\"keyword\">if</span> err != <span class=\"literal\">nil</span> &#123;</span><br><span class=\"line\">\t\tlog.Fatalf(<span class=\"string\">&quot;Failed to create cert file: %v&quot;</span>, err)</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\t<span class=\"keyword\">defer</span> certFile.Close()</span><br><span class=\"line\">\terr = pem.Encode(certFile, &amp;pem.Block&#123;Type: <span class=\"string\">&quot;CERTIFICATE&quot;</span>, Bytes: certDER&#125;)</span><br><span class=\"line\">\t<span class=\"keyword\">if</span> err != <span class=\"literal\">nil</span> &#123;</span><br><span class=\"line\">\t\tlog.Fatalf(<span class=\"string\">&quot;Failed to write cert to file: %v&quot;</span>, err)</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"comment\">// 保存私钥文件</span></span><br><span class=\"line\">\tkeyFile, err := os.Create(fmt.Sprintf(<span class=\"string\">&quot;%s.key&quot;</span>, ip))</span><br><span class=\"line\">\t<span class=\"keyword\">if</span> err != <span class=\"literal\">nil</span> &#123;</span><br><span class=\"line\">\t\tlog.Fatalf(<span class=\"string\">&quot;Failed to create key file: %v&quot;</span>, err)</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\t<span class=\"keyword\">defer</span> keyFile.Close()</span><br><span class=\"line\">\tprivBytes, err := x509.MarshalECPrivateKey(priv)</span><br><span class=\"line\">\t<span class=\"keyword\">if</span> err != <span class=\"literal\">nil</span> &#123;</span><br><span class=\"line\">\t\tlog.Fatalf(<span class=\"string\">&quot;Failed to marshal private key: %v&quot;</span>, err)</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\terr = pem.Encode(keyFile, &amp;pem.Block&#123;Type: <span class=\"string\">&quot;EC PRIVATE KEY&quot;</span>, Bytes: privBytes&#125;)</span><br><span class=\"line\">\t<span class=\"keyword\">if</span> err != <span class=\"literal\">nil</span> &#123;</span><br><span class=\"line\">\t\tlog.Fatalf(<span class=\"string\">&quot;Failed to write key to file: %v&quot;</span>, err)</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">\tfmt.Println(<span class=\"string\">&quot;Certificate and key saved successfully!&quot;</span>)</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>在执行 <code>go run main.go</code></p>\n<p>就会在当前目录下生成以你填的 IP 命名的 <code>.crt</code>  和 <code>.key</code>  密钥</p>\n<p>这时，官方的第二步就可以改成</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">sudo derper -a :8888 -http-port -1 -stun-port 8889 -hostname x.x.x.x --certmode manual -certdir ~/certdir</span><br></pre></td></tr></table></figure>\n<p>参数解释：</p>\n<p><code>x.x.x.x</code>  换成你的 IP</p>\n<p><code>-1</code>  表示禁用了 http 的端口</p>\n<p><code>8888</code>  为 https 的端口</p>\n<p><code>8889</code>  为 stun 端口</p>\n<p>当你能看到下面这段日志输出，就说明启动成功了。</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">2025/01/11 11:36:28 derper: serving on :8888 with TLS</span><br><span class=\"line\">2025/01/11 11:36:28 running STUN server on [::]:8889</span><br></pre></td></tr></table></figure>\n<p>不要结束服务，此时你自己的电脑或者需要连接到 tailscale 的机器上输入 <code>curl --insecure &quot;https://x.x.x.x:8888&quot;</code></p>\n<p>看到下面这串输出，就说明 derp 搭建成功了。</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;html&gt;&lt;body&gt;</span><br><span class=\"line\">&lt;h1&gt;DERP&lt;/h1&gt;</span><br><span class=\"line\">&lt;p&gt;</span><br><span class=\"line\">  This is a &lt;a href=&quot;https://tailscale.com/&quot;&gt;Tailscale&lt;/a&gt; DERP server.</span><br><span class=\"line\">&lt;/p&gt;</span><br><span class=\"line\"></span><br><span class=\"line\">&lt;p&gt;</span><br><span class=\"line\">  It provides STUN, interactive connectivity establishment, and relaying of end-to-end encrypted traffic</span><br><span class=\"line\">  for Tailscale clients.</span><br><span class=\"line\">&lt;/p&gt;</span><br><span class=\"line\">...</span><br></pre></td></tr></table></figure>\n<h3 id=\"注册自己的derp服务到列表中\"><a class=\"markdownIt-Anchor\" href=\"#注册自己的derp服务到列表中\">#</a> 注册自己的 Derp 服务到列表中</h3>\n<h4 id=\"如果你用的tailscale官方服务\"><a class=\"markdownIt-Anchor\" href=\"#如果你用的tailscale官方服务\">#</a> 如果你用的 tailscale 官方服务，</h4>\n<p>到 <a href=\"https://login.tailscale.com/admin/acls/file\">https://login.tailscale.com/admin/acls/file</a> 添加你的 Derp 服务器，这里给出参考配置</p>\n<figure class=\"highlight json\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attr\">&quot;derpMap&quot;</span><span class=\"punctuation\">:</span> <span class=\"punctuation\">&#123;</span></span><br><span class=\"line\">    <span class=\"attr\">&quot;Regions&quot;</span><span class=\"punctuation\">:</span> <span class=\"punctuation\">&#123;</span></span><br><span class=\"line\">        <span class=\"attr\">&quot;901&quot;</span><span class=\"punctuation\">:</span> <span class=\"punctuation\">&#123;</span></span><br><span class=\"line\">            <span class=\"attr\">&quot;RegionID&quot;</span><span class=\"punctuation\">:</span> <span class=\"number\">901</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">            <span class=\"attr\">&quot;RegionCode&quot;</span><span class=\"punctuation\">:</span> <span class=\"string\">&quot;ali-sz&quot;</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">            <span class=\"attr\">&quot;RegionName&quot;</span><span class=\"punctuation\">:</span> <span class=\"string\">&quot;Aliyun Shenzhen&quot;</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">            <span class=\"attr\">&quot;Nodes&quot;</span><span class=\"punctuation\">:</span> <span class=\"punctuation\">[</span></span><br><span class=\"line\">                <span class=\"punctuation\">&#123;</span></span><br><span class=\"line\">                    <span class=\"attr\">&quot;Name&quot;</span><span class=\"punctuation\">:</span> <span class=\"string\">&quot;901a&quot;</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">                    <span class=\"attr\">&quot;RegionID&quot;</span><span class=\"punctuation\">:</span> <span class=\"number\">901</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">                    <span class=\"attr\">&quot;DERPPort&quot;</span><span class=\"punctuation\">:</span> <span class=\"number\">8888</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">                    <span class=\"attr\">&quot;STUNPort&quot;</span><span class=\"punctuation\">:</span> <span class=\"number\">8889</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">                    <span class=\"attr\">&quot;IPv4&quot;</span><span class=\"punctuation\">:</span> <span class=\"string\">&quot;x.x.x.x&quot;</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">                    <span class=\"attr\">&quot;InsecureForTests&quot;</span><span class=\"punctuation\">:</span> <span class=\"literal\"><span class=\"keyword\">true</span></span></span><br><span class=\"line\">                <span class=\"punctuation\">&#125;</span></span><br><span class=\"line\">            <span class=\"punctuation\">]</span></span><br><span class=\"line\">        <span class=\"punctuation\">&#125;</span></span><br><span class=\"line\">    <span class=\"punctuation\">&#125;</span></span><br><span class=\"line\"><span class=\"punctuation\">&#125;</span></span><br></pre></td></tr></table></figure>\n<h4 id=\"如果你用的headscale\"><a class=\"markdownIt-Anchor\" href=\"#如果你用的headscale\">#</a> 如果你用的 Headscale</h4>\n<p>你可以参考我上篇关于 headscale 搭建的部分，配置文件默认在这个目录 <code>/etc/headscale/config.yaml</code></p>\n<p>修改其中的 urls 部分</p>\n<figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># /etc/headscale/config.yaml</span></span><br><span class=\"line\"><span class=\"attr\">derp:</span></span><br><span class=\"line\">  <span class=\"comment\"># List of externally available DERP maps encoded in JSON</span></span><br><span class=\"line\">  <span class=\"attr\">urls:</span></span><br><span class=\"line\">    <span class=\"bullet\">-</span> <span class=\"string\">https://controlplane.tailscale.com/derpmap/default</span></span><br><span class=\"line\">    <span class=\"bullet\">-</span> <span class=\"string\">http://xxxx/derp.json</span></span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"comment\"># Locally available DERP map files encoded in YAML</span></span><br><span class=\"line\">  <span class=\"comment\">#</span></span><br><span class=\"line\">  <span class=\"comment\"># This option is mostly interesting for people hosting</span></span><br><span class=\"line\">  <span class=\"comment\"># their own DERP servers:</span></span><br><span class=\"line\">  <span class=\"comment\"># https://tailscale.com/kb/1118/custom-derp-servers/</span></span><br><span class=\"line\">  <span class=\"comment\">#</span></span><br><span class=\"line\">  <span class=\"comment\"># paths:</span></span><br><span class=\"line\">  <span class=\"comment\">#   - /etc/headscale/derp-example.yaml</span></span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"comment\"># If enabled, a worker will be set up to periodically</span></span><br><span class=\"line\">  <span class=\"comment\"># refresh the given sources and update the derpmap</span></span><br><span class=\"line\">  <span class=\"comment\"># will be set up.</span></span><br><span class=\"line\">  <span class=\"attr\">auto_update_enabled:</span> <span class=\"literal\">true</span></span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"comment\"># How often should we check for DERP updates?</span></span><br><span class=\"line\">  <span class=\"attr\">update_frequency:</span> <span class=\"string\">24h</span></span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<p><code>http://xxxx.com/derp.json</code>  这个路径可以修改你 derp 服务器能够访问的地址，自己搭个 nginx 或者放到 oss 上之类的。</p>\n<p>返回的内容如下：</p>\n<figure class=\"highlight json\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"punctuation\">&#123;</span></span><br><span class=\"line\">    <span class=\"attr\">&quot;Regions&quot;</span><span class=\"punctuation\">:</span> <span class=\"punctuation\">&#123;</span></span><br><span class=\"line\">        <span class=\"attr\">&quot;901&quot;</span><span class=\"punctuation\">:</span> <span class=\"punctuation\">&#123;</span></span><br><span class=\"line\">            <span class=\"attr\">&quot;RegionID&quot;</span><span class=\"punctuation\">:</span> <span class=\"number\">901</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">            <span class=\"attr\">&quot;RegionCode&quot;</span><span class=\"punctuation\">:</span> <span class=\"string\">&quot;ali-sz&quot;</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">            <span class=\"attr\">&quot;RegionName&quot;</span><span class=\"punctuation\">:</span> <span class=\"string\">&quot;Aliyun Shenzhen&quot;</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">            <span class=\"attr\">&quot;Nodes&quot;</span><span class=\"punctuation\">:</span> <span class=\"punctuation\">[</span></span><br><span class=\"line\">                <span class=\"punctuation\">&#123;</span></span><br><span class=\"line\">                    <span class=\"attr\">&quot;Name&quot;</span><span class=\"punctuation\">:</span> <span class=\"string\">&quot;901a&quot;</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">                    <span class=\"attr\">&quot;RegionID&quot;</span><span class=\"punctuation\">:</span> <span class=\"number\">901</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">                    <span class=\"attr\">&quot;DERPPort&quot;</span><span class=\"punctuation\">:</span> <span class=\"number\">8888</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">                    <span class=\"attr\">&quot;STUNPort&quot;</span><span class=\"punctuation\">:</span> <span class=\"number\">8889</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">                    <span class=\"attr\">&quot;IPv4&quot;</span><span class=\"punctuation\">:</span> <span class=\"string\">&quot;x.x.x.x&quot;</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">                    <span class=\"attr\">&quot;InsecureForTests&quot;</span><span class=\"punctuation\">:</span> <span class=\"literal\"><span class=\"keyword\">true</span></span></span><br><span class=\"line\">                <span class=\"punctuation\">&#125;</span></span><br><span class=\"line\">            <span class=\"punctuation\">]</span></span><br><span class=\"line\">        <span class=\"punctuation\">&#125;</span></span><br><span class=\"line\">    <span class=\"punctuation\">&#125;</span></span><br><span class=\"line\"><span class=\"punctuation\">&#125;</span></span><br></pre></td></tr></table></figure>\n<h3 id=\"检查自定义derp是否生效\"><a class=\"markdownIt-Anchor\" href=\"#检查自定义derp是否生效\">#</a> 检查自定义 Derp 是否生效</h3>\n<p>检查你的客户端是否能够正常检索到自己的 Derp 服务器</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">tailscale netcheck</span><br><span class=\"line\"></span><br><span class=\"line\">Report:</span><br><span class=\"line\">        * UDP: <span class=\"literal\">true</span></span><br><span class=\"line\">        * IPv4: <span class=\"built_in\">yes</span>, xxxxx</span><br><span class=\"line\">        * IPv6: no, but OS has support</span><br><span class=\"line\">        * MappingVariesByDestIP: <span class=\"literal\">true</span></span><br><span class=\"line\">        * HairPinning: <span class=\"literal\">false</span></span><br><span class=\"line\">        * PortMapping:</span><br><span class=\"line\">        * CaptivePortal: <span class=\"literal\">false</span></span><br><span class=\"line\">        * Nearest DERP: Aliyun Shenzhen</span><br><span class=\"line\">        * DERP latency:</span><br><span class=\"line\">                - ali-sz: 13ms    (Aliyun Shenzhen)</span><br><span class=\"line\">                - lax: 165.8ms (Los Angeles)</span><br><span class=\"line\">                - sfo: 173ms   (San Francisco)</span><br><span class=\"line\">                - tok: 173.8ms (Tokyo)</span><br><span class=\"line\">                - sea: 175.6ms (Seattle)</span><br><span class=\"line\">                - den: 181.5ms (Denver)</span><br><span class=\"line\">                - den: 181.5ms (Denver)</span><br><span class=\"line\">                - den: 181.5ms (Denver)</span><br><span class=\"line\">                - den: 181.5ms (Denver)</span><br><span class=\"line\">                - den: 181.5ms (Denver)</span><br><span class=\"line\">                - dfw: 184.1ms (Dallas)</span><br><span class=\"line\">                - ord: 200.7ms (Chicago)</span><br><span class=\"line\">                - den: 181.5ms (Denver)</span><br><span class=\"line\">                - dfw: 184.1ms (Dallas)</span><br><span class=\"line\">                - ord: 200.7ms (Chicago)</span><br><span class=\"line\">                - hkg: 207.5ms (Hong Kong)</span><br><span class=\"line\">                - hnl: 209ms   (Honolulu)</span><br><span class=\"line\">                - nyc: 213.5ms (New York City)</span><br><span class=\"line\">                - mia: 220.6ms (Miami)</span><br><span class=\"line\">                - iad: 223.6ms (Ashburn)</span><br><span class=\"line\">                - par: 229ms   (Paris)</span><br><span class=\"line\">                - lhr: 230.2ms (London)</span><br><span class=\"line\">                - tor: 231.1ms (Toronto)</span><br><span class=\"line\">                - sin: 234.8ms (Singapore)</span><br><span class=\"line\">                - fra: 238.3ms (Frankfurt)</span><br><span class=\"line\">                - ams: 248.9ms (Amsterdam)</span><br><span class=\"line\">                - nue: 253.4ms (Nuremberg)</span><br><span class=\"line\">                - mad: 266.3ms (Madrid)</span><br><span class=\"line\">                - waw: 266.6ms (Warsaw)</span><br><span class=\"line\">                - blr: 271.1ms (Bangalore)</span><br><span class=\"line\">                - syd: 322ms   (Sydney)</span><br><span class=\"line\">                - sao: 330.8ms (São Paulo)</span><br><span class=\"line\">                - dbi: 348.1ms (Dubai)</span><br><span class=\"line\">                - jnb: 384.2ms (Johannesburg)</span><br><span class=\"line\">                - nai: 393.9ms (Nairobi)</span><br></pre></td></tr></table></figure>\n<h3 id=\"derp服务安全\"><a class=\"markdownIt-Anchor\" href=\"#derp服务安全\">#</a> Derp 服务安全</h3>\n<p>前面跑起来的 Derp 服务，其他人只要知道了 IP 和端口是可以访问的。</p>\n<p>因此需要额外进行一些处理。</p>\n<p>你需要在 Derp 服务器上安装 Tailscale 客户端</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">curl -fsSL https://tailscale.com/install.sh | sh</span><br></pre></td></tr></table></figure>\n<p>然后注册到你的 Tailscale 中</p>\n<p>之后在 Derper 启动时添加参数 <code> --verify-clients</code>  这个只允许你的 Tailscale 中的机器才能访问。</p>\n<p>完整的命令如下</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">derper -a :8888 -http-port -1 -stun-port 8889 -hostname x.x.x.x --certmode manual -certdir ~/certdir --verify-clients</span><br></pre></td></tr></table></figure>\n<p>最后可以将 Derper 注册成服务，自动启动。</p>\n<p>ubuntu 参考</p>\n<figure class=\"highlight ini\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># vim /etc/systemd/system/derp.service</span></span><br><span class=\"line\"><span class=\"section\">[Unit]</span></span><br><span class=\"line\"><span class=\"attr\">Description</span>=Derper</span><br><span class=\"line\"><span class=\"attr\">After</span>=network.target</span><br><span class=\"line\"><span class=\"attr\">Wants</span>=network.target</span><br><span class=\"line\"><span class=\"section\">[Service]</span></span><br><span class=\"line\"><span class=\"attr\">User</span>=root</span><br><span class=\"line\"><span class=\"attr\">Restart</span>=always</span><br><span class=\"line\"><span class=\"attr\">ExecStart</span>=derper -a :<span class=\"number\">8888</span> -http-port -<span class=\"number\">1</span> -stun-port <span class=\"number\">8889</span> -hostname x.x.x.x --certmode manual -certdir ~/certdir --verify-clients</span><br><span class=\"line\"><span class=\"attr\">RestartPreventExitStatus</span>=<span class=\"number\">1</span></span><br><span class=\"line\"><span class=\"section\">[Install]</span></span><br><span class=\"line\"><span class=\"attr\">WantedBy</span>=multi-user.target</span><br></pre></td></tr></table></figure>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"># 重新加载Systemd配置</span><br><span class=\"line\">sudo systemctl daemon-reload</span><br><span class=\"line\"></span><br><span class=\"line\"># 启动服务并设置开机自启动</span><br><span class=\"line\">sudo systemctl start derp</span><br><span class=\"line\">sudo systemctl enable derp</span><br></pre></td></tr></table></figure>\n",
            "tags": []
        },
        {
            "id": "https://bigorange.work/p/489377b1/",
            "url": "https://bigorange.work/p/489377b1/",
            "title": "如何成为一名监督帕鲁的服主",
            "date_published": "2024-02-29T13:15:36.000Z",
            "content_html": "<h2 id=\"前言\"><a class=\"markdownIt-Anchor\" href=\"#前言\">#</a> 前言</h2>\n<p>帕鲁刚推出没多久，就有朋友告诉了我</p>\n<p>咋一看，这不宝可梦吗，作为<s>口袋妖怪</s>宝可梦玩家，果断开玩。</p>\n<p>这不，最近跟朋友们一起玩的帕鲁服务器也已经将近 2000 个游戏日了。</p>\n<p><img src=\"https://gcore.jsdelivr.net/gh/antengye/picgo-db/hexo/202402292123546.png\" alt=\"服务器截图\"></p>\n<p>作为 “腐竹”，为了能够提供给朋友最佳的游戏体验，自然是要好好维护好帕鲁服务器的。</p>\n<p>以下的内容应该可以初步帮助新手腐竹们搭建并管理自己的独立服务器。</p>\n<h2 id=\"服务器的抉择\"><a class=\"markdownIt-Anchor\" href=\"#服务器的抉择\">#</a> 服务器的抉择</h2>\n<p>考虑到有个朋友是晚上 6 点起床，不知道几点睡觉的 “神人”</p>\n<p>所以服务器的就要优先考虑 24 小时运行了。</p>\n<p>一般来说服务器就是考虑两种</p>\n<h3 id=\"公有云服务器\"><a class=\"markdownIt-Anchor\" href=\"#公有云服务器\">#</a> 公有云服务器</h3>\n<p>游戏服务器，可以无脑直接上<a href=\"https://curl.qcloud.com/onNGAwX7\">腾讯云</a>、<a href=\"https://www.aliyun.com/daily-act/ecs/activity_selection?userCode=vipdg4bo\">阿里云</a>等购买即可。</p>\n<p>优点在于，这类服务器可以直接提供一个公共 IP 供朋友直接访问。</p>\n<p>缺点就是服务器的价格摆在那。</p>\n<p>对于新手来说建议用公有云。</p>\n<h3 id=\"私有服务器\"><a class=\"markdownIt-Anchor\" href=\"#私有服务器\">#</a> 私有服务器</h3>\n<p>诸如：自己的电脑、私人服务器等。</p>\n<p>优缺点和上面就是反着来了。</p>\n<p>我自己选择的是用私人服务器 + tailscale 的内网穿透模式。好处是省了一笔费用，坏处是需要一定的动手能力，tailscale 的搭建可以看上一篇文章。</p>\n<h3 id=\"配置\"><a class=\"markdownIt-Anchor\" href=\"#配置\">#</a> 配置</h3>\n<p>至于服务的配置方面，每个游戏的需求量不一样。</p>\n<p>比如帕鲁的服务端资源需求：<a href=\"https://tech.palworldgame.com/getting-started/requirements\">https://tech.palworldgame.com/getting-started/requirements</a></p>\n<p>最低建议是 4 核 8G（预计支撑 3-4 人）。但是帕鲁目前的优化很差，所以还得及时重启，不然会有爆内存的风险。</p>\n<h2 id=\"服务端安装\"><a class=\"markdownIt-Anchor\" href=\"#服务端安装\">#</a> 服务端安装</h2>\n<p>在纠结完服务器后，就可以动手进行服务端的安装了。</p>\n<p>虽然帕鲁官方提供了安装服务端的流程，而且也不算复杂。</p>\n<p>但是考虑到后期可能存在的服务器迁移情况，还是建议用上 docker。</p>\n<h3 id=\"docker\"><a class=\"markdownIt-Anchor\" href=\"#docker\">#</a> Docker</h3>\n<p>简单解释一下 docker 的用处：整合游戏服务器需要的环境，一条命令启动。</p>\n<p>Docker 的安装方式有很多，这里给到 Docker 官方的一键脚本：</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">curl -fsSL get.docker.com -o get-docker.sh</span><br><span class=\"line\">sudo sh get-docker.sh --mirror Aliyun</span><br></pre></td></tr></table></figure>\n<h3 id=\"docker-compose\"><a class=\"markdownIt-Anchor\" href=\"#docker-compose\">#</a> Docker-compose</h3>\n<p>Docker-compose 又是干什么的？<s>编排巴拉巴拉的…</s></p>\n<p>其实目前阶段只需要知道，它就是简化 docker 的命令，实现：一条简短的命令启动。</p>\n<p>现在的 docker 安装的时候一般都带上了 Docker-compose</p>\n<p>可以输入命令 <code>docker compose --help</code>  测试下是否有了</p>\n<h3 id=\"部署启动\"><a class=\"markdownIt-Anchor\" href=\"#部署启动\">#</a> 部署 + 启动</h3>\n<p>找一个目录如 <code>server</code> ，创建好一个文件： <code>docker-compose.yml</code></p>\n<p>把下面这段内容填进去</p>\n<figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attr\">version:</span> <span class=\"string\">&#x27;3.9&#x27;</span></span><br><span class=\"line\"><span class=\"attr\">services:</span></span><br><span class=\"line\">  <span class=\"attr\">palworld-dedicated-server:</span></span><br><span class=\"line\">    <span class=\"attr\">container_name:</span> <span class=\"string\">palworld-dedicated-server</span></span><br><span class=\"line\">    <span class=\"attr\">image:</span> <span class=\"string\">jammsen/palworld-dedicated-server:latest</span></span><br><span class=\"line\">    <span class=\"attr\">restart:</span> <span class=\"string\">unless-stopped</span></span><br><span class=\"line\">    <span class=\"attr\">ports:</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"attr\">target:</span> <span class=\"number\">8211</span> <span class=\"comment\"># Gamerserver port inside of the container</span></span><br><span class=\"line\">        <span class=\"attr\">published:</span> <span class=\"number\">8211</span> <span class=\"comment\"># Gamerserver port on your host</span></span><br><span class=\"line\">        <span class=\"attr\">protocol:</span> <span class=\"string\">udp</span></span><br><span class=\"line\">        <span class=\"attr\">mode:</span> <span class=\"string\">host</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"attr\">target:</span> <span class=\"number\">25575</span> <span class=\"comment\"># RCON port inside of the container</span></span><br><span class=\"line\">        <span class=\"attr\">published:</span> <span class=\"number\">25575</span> <span class=\"comment\"># RCON port on your host</span></span><br><span class=\"line\">        <span class=\"attr\">protocol:</span> <span class=\"string\">tcp</span></span><br><span class=\"line\">        <span class=\"attr\">mode:</span> <span class=\"string\">host</span></span><br><span class=\"line\">    <span class=\"attr\">env_file:</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"string\">./default.env</span></span><br><span class=\"line\">    <span class=\"attr\">volumes:</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"string\">./game:/palworld</span></span><br></pre></td></tr></table></figure>\n<p>现在就可以执行<strong>一条简短的命令启动</strong>： <code>docker compose up -d</code></p>\n<p>什么？没启动起来。</p>\n<p>噢，因为有这两个配置的原因</p>\n<pre><code>env_file:\n  - ./default.env\nvolumes:\n  - ./game:/palworld\n</code></pre>\n<p>后面解释，先在 <code>docker-compose.yml</code>  同级目录下创建</p>\n<p>default.env 文件，复制粘贴进去。</p>\n<figure class=\"highlight ini\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br><span class=\"line\">105</span><br><span class=\"line\">106</span><br><span class=\"line\">107</span><br><span class=\"line\">108</span><br><span class=\"line\">109</span><br><span class=\"line\">110</span><br><span class=\"line\">111</span><br><span class=\"line\">112</span><br><span class=\"line\">113</span><br><span class=\"line\">114</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># Container-setttings</span></span><br><span class=\"line\"><span class=\"attr\">PUID</span>=<span class=\"number\">1000</span></span><br><span class=\"line\"><span class=\"attr\">PGID</span>=<span class=\"number\">1000</span></span><br><span class=\"line\"><span class=\"attr\">TZ</span>=Europe/Berlin</span><br><span class=\"line\"><span class=\"comment\"># SteamCMD-settings</span></span><br><span class=\"line\"><span class=\"attr\">ALWAYS_UPDATE_ON_START</span>=<span class=\"literal\">true</span></span><br><span class=\"line\"><span class=\"attr\">STEAMCMD_VALIDATE_FILES</span>=<span class=\"literal\">true</span></span><br><span class=\"line\"><span class=\"comment\"># Backup-settings</span></span><br><span class=\"line\"><span class=\"attr\">BACKUP_ENABLED</span>=<span class=\"literal\">true</span></span><br><span class=\"line\"><span class=\"attr\">BACKUP_CRON_EXPRESSION</span>=<span class=\"number\">0</span> * * * *</span><br><span class=\"line\"><span class=\"attr\">BACKUP_RETENTION_POLICY</span>=<span class=\"literal\">true</span></span><br><span class=\"line\"><span class=\"attr\">BACKUP_RETENTION_AMOUNT_TO_KEEP</span>=<span class=\"number\">72</span></span><br><span class=\"line\"><span class=\"comment\"># Restart-settings</span></span><br><span class=\"line\"><span class=\"attr\">RESTART_ENABLED</span>=<span class=\"literal\">false</span></span><br><span class=\"line\"><span class=\"attr\">RESTART_DEBUG_OVERRIDE</span>=<span class=\"literal\">false</span></span><br><span class=\"line\"><span class=\"attr\">RESTART_CRON_EXPRESSION</span>=<span class=\"string\">&quot;0 18 * * *&quot;</span></span><br><span class=\"line\"><span class=\"comment\"># RCON-Playerdection - NEEDS RCON ENABLED!</span></span><br><span class=\"line\"><span class=\"attr\">RCON_PLAYER_DETECTION</span>=<span class=\"literal\">true</span></span><br><span class=\"line\"><span class=\"attr\">RCON_PLAYER_DETECTION_STARTUP_DELAY</span>=<span class=\"number\">60</span></span><br><span class=\"line\"><span class=\"attr\">RCON_PLAYER_DETECTION_CHECK_INTERVAL</span>=<span class=\"number\">15</span></span><br><span class=\"line\"><span class=\"comment\"># Webhook-settings</span></span><br><span class=\"line\"><span class=\"attr\">WEBHOOK_ENABLED</span>=<span class=\"literal\">false</span></span><br><span class=\"line\"><span class=\"attr\">WEBHOOK_DEBUG_ENABLED</span>=<span class=\"literal\">false</span></span><br><span class=\"line\"><span class=\"attr\">WEBHOOK_URL</span>=<span class=\"string\">&quot;YOUR-URL-IN-HERE&quot;</span></span><br><span class=\"line\"><span class=\"attr\">WEBHOOK_CONTENT_TITLE</span>=<span class=\"string\">&quot;Status update&quot;</span></span><br><span class=\"line\"><span class=\"attr\">WEBHOOK_INFO_TITLE</span>=<span class=\"string\">&quot;Info&quot;</span></span><br><span class=\"line\"><span class=\"attr\">WEBHOOK_INFO_DESCRIPTION</span>=<span class=\"string\">&quot;This is an info from the server&quot;</span></span><br><span class=\"line\"><span class=\"attr\">WEBHOOK_INFO_COLOR</span>=<span class=\"string\">&quot;2849520&quot;</span></span><br><span class=\"line\"><span class=\"attr\">WEBHOOK_INSTALL_TITLE</span>=<span class=\"string\">&quot;Installing server&quot;</span></span><br><span class=\"line\"><span class=\"attr\">WEBHOOK_INSTALL_DESCRIPTION</span>=<span class=\"string\">&quot;Server is being installed&quot;</span></span><br><span class=\"line\"><span class=\"attr\">WEBHOOK_INSTALL_COLOR</span>=<span class=\"string\">&quot;2849520&quot;</span></span><br><span class=\"line\"><span class=\"attr\">WEBHOOK_RESTART_TITLE</span>=<span class=\"string\">&quot;Server is restarting soon&quot;</span></span><br><span class=\"line\"><span class=\"attr\">WEBHOOK_RESTART_DESCRIPTION</span>=<span class=\"string\">&quot;The gameserver is restarting in 15 minutes&quot;</span></span><br><span class=\"line\"><span class=\"attr\">WEBHOOK_RESTART_COLOR</span>=<span class=\"string\">&quot;15593515&quot;</span></span><br><span class=\"line\"><span class=\"attr\">WEBHOOK_START_TITLE</span>=<span class=\"string\">&quot;Server is starting&quot;</span></span><br><span class=\"line\"><span class=\"attr\">WEBHOOK_START_DESCRIPTION</span>=<span class=\"string\">&quot;The gameserver is starting&quot;</span></span><br><span class=\"line\"><span class=\"attr\">WEBHOOK_START_COLOR</span>=<span class=\"string\">&quot;2328576&quot;</span></span><br><span class=\"line\"><span class=\"attr\">WEBHOOK_STOP_TITLE</span>=<span class=\"string\">&quot;Server has been stopped&quot;</span></span><br><span class=\"line\"><span class=\"attr\">WEBHOOK_STOP_DESCRIPTION</span>=<span class=\"string\">&quot;The gameserver has been stopped&quot;</span></span><br><span class=\"line\"><span class=\"attr\">WEBHOOK_STOP_COLOR</span>=<span class=\"string\">&quot;7413016&quot;</span></span><br><span class=\"line\"><span class=\"attr\">WEBHOOK_UPDATE_TITLE</span>=<span class=\"string\">&quot;Updating server&quot;</span></span><br><span class=\"line\"><span class=\"attr\">WEBHOOK_UPDATE_DESCRIPTION</span>=<span class=\"string\">&quot;Server is being updated&quot;</span></span><br><span class=\"line\"><span class=\"attr\">WEBHOOK_UPDATE_COLOR</span>=<span class=\"string\">&quot;2849520&quot;</span></span><br><span class=\"line\"><span class=\"comment\"># Config-setting - Warning: Every setting below here will be affected!</span></span><br><span class=\"line\"><span class=\"attr\">SERVER_SETTINGS_MODE</span>=auto</span><br><span class=\"line\"><span class=\"comment\"># Gameserver-start-settings</span></span><br><span class=\"line\"><span class=\"attr\">MULTITHREAD_ENABLED</span>=<span class=\"literal\">true</span></span><br><span class=\"line\"><span class=\"attr\">COMMUNITY_SERVER</span>=<span class=\"literal\">true</span></span><br><span class=\"line\"><span class=\"comment\"># Engine.ini settings</span></span><br><span class=\"line\"><span class=\"attr\">NETSERVERMAXTICKRATE</span>=<span class=\"number\">120</span></span><br><span class=\"line\"><span class=\"comment\"># PalWorldSettings.ini settings</span></span><br><span class=\"line\"><span class=\"attr\">DIFFICULTY</span>=None</span><br><span class=\"line\"><span class=\"attr\">DAYTIME_SPEEDRATE</span>=<span class=\"number\">1.000000</span></span><br><span class=\"line\"><span class=\"attr\">NIGHTTIME_SPEEDRATE</span>=<span class=\"number\">1.000000</span></span><br><span class=\"line\"><span class=\"attr\">EXP_RATE</span>=<span class=\"number\">1.000000</span></span><br><span class=\"line\"><span class=\"attr\">PAL_CAPTURE_RATE</span>=<span class=\"number\">1.000000</span></span><br><span class=\"line\"><span class=\"attr\">PAL_SPAWN_NUM_RATE</span>=<span class=\"number\">1.000000</span></span><br><span class=\"line\"><span class=\"attr\">PAL_DAMAGE_RATE_ATTACK</span>=<span class=\"number\">1.000000</span></span><br><span class=\"line\"><span class=\"attr\">PAL_DAMAGE_RATE_DEFENSE</span>=<span class=\"number\">1.000000</span></span><br><span class=\"line\"><span class=\"attr\">PLAYER_DAMAGE_RATE_ATTACK</span>=<span class=\"number\">1.000000</span></span><br><span class=\"line\"><span class=\"attr\">PLAYER_DAMAGE_RATE_DEFENSE</span>=<span class=\"number\">1.000000</span></span><br><span class=\"line\"><span class=\"attr\">PLAYER_STOMACH_DECREASE_RATE</span>=<span class=\"number\">1.000000</span></span><br><span class=\"line\"><span class=\"attr\">PLAYER_STAMINA_DECREACE_RATE</span>=<span class=\"number\">1.000000</span></span><br><span class=\"line\"><span class=\"attr\">PLAYER_AUTO_HP_REGENE_RATE</span>=<span class=\"number\">1.000000</span></span><br><span class=\"line\"><span class=\"attr\">PLAYER_AUTO_HP_REGENE_RATE_IN_SLEEP</span>=<span class=\"number\">1.000000</span></span><br><span class=\"line\"><span class=\"attr\">PAL_STOMACH_DECREACE_RATE</span>=<span class=\"number\">1.000000</span></span><br><span class=\"line\"><span class=\"attr\">PAL_STAMINA_DECREACE_RATE</span>=<span class=\"number\">1.000000</span></span><br><span class=\"line\"><span class=\"attr\">PAL_AUTO_HP_REGENE_RATE</span>=<span class=\"number\">1.000000</span></span><br><span class=\"line\"><span class=\"attr\">PAL_AUTO_HP_REGENE_RATE_IN_SLEEP</span>=<span class=\"number\">1.000000</span></span><br><span class=\"line\"><span class=\"attr\">BUILD_OBJECT_DAMAGE_RATE</span>=<span class=\"number\">1.000000</span></span><br><span class=\"line\"><span class=\"attr\">BUILD_OBJECT_DETERIORATION_DAMAGE_RATE</span>=<span class=\"number\">1.000000</span></span><br><span class=\"line\"><span class=\"attr\">COLLECTION_DROP_RATE</span>=<span class=\"number\">1.000000</span></span><br><span class=\"line\"><span class=\"attr\">COLLECTION_OBJECT_HP_RATE</span>=<span class=\"number\">1.000000</span></span><br><span class=\"line\"><span class=\"attr\">COLLECTION_OBJECT_RESPAWN_SPEED_RATE</span>=<span class=\"number\">1.000000</span></span><br><span class=\"line\"><span class=\"attr\">ENEMY_DROP_ITEM_RATE</span>=<span class=\"number\">1.000000</span></span><br><span class=\"line\"><span class=\"attr\">DEATH_PENALTY</span>=All</span><br><span class=\"line\"><span class=\"attr\">ENABLE_PLAYER_TO_PLAYER_DAMAGE</span>=<span class=\"literal\">false</span></span><br><span class=\"line\"><span class=\"attr\">ENABLE_FRIENDLY_FIRE</span>=<span class=\"literal\">false</span></span><br><span class=\"line\"><span class=\"attr\">ENABLE_INVADER_ENEMY</span>=<span class=\"literal\">true</span></span><br><span class=\"line\"><span class=\"attr\">ACTIVE_UNKO</span>=<span class=\"literal\">false</span></span><br><span class=\"line\"><span class=\"attr\">ENABLE_AIM_ASSIST_PAD</span>=<span class=\"literal\">true</span></span><br><span class=\"line\"><span class=\"attr\">ENABLE_AIM_ASSIST_KEYBOARD</span>=<span class=\"literal\">false</span></span><br><span class=\"line\"><span class=\"attr\">DROP_ITEM_MAX_NUM</span>=<span class=\"number\">3000</span></span><br><span class=\"line\"><span class=\"attr\">DROP_ITEM_MAX_NUM_UNKO</span>=<span class=\"number\">100</span></span><br><span class=\"line\"><span class=\"attr\">BASE_CAMP_MAX_NUM</span>=<span class=\"number\">128</span></span><br><span class=\"line\"><span class=\"attr\">BASE_CAMP_WORKER_MAXNUM</span>=<span class=\"number\">15</span></span><br><span class=\"line\"><span class=\"attr\">DROP_ITEM_ALIVE_MAX_HOURS</span>=<span class=\"number\">1.000000</span></span><br><span class=\"line\"><span class=\"attr\">AUTO_RESET_GUILD_NO_ONLINE_PLAYERS</span>=<span class=\"literal\">false</span></span><br><span class=\"line\"><span class=\"attr\">AUTO_RESET_GUILD_TIME_NO_ONLINE_PLAYERS</span>=<span class=\"number\">72.000000</span></span><br><span class=\"line\"><span class=\"attr\">GUILD_PLAYER_MAX_NUM</span>=<span class=\"number\">20</span></span><br><span class=\"line\"><span class=\"attr\">PAL_EGG_DEFAULT_HATCHING_TIME</span>=<span class=\"number\">72.000000</span></span><br><span class=\"line\"><span class=\"attr\">WORK_SPEED_RATE</span>=<span class=\"number\">1.000000</span></span><br><span class=\"line\"><span class=\"attr\">IS_MULTIPLAY</span>=<span class=\"literal\">false</span></span><br><span class=\"line\"><span class=\"attr\">IS_PVP</span>=<span class=\"literal\">false</span></span><br><span class=\"line\"><span class=\"attr\">CAN_PICKUP_OTHER_GUILD_DEATH_PENALTY_DROP</span>=<span class=\"literal\">false</span></span><br><span class=\"line\"><span class=\"attr\">ENABLE_NON_LOGIN_PENALTY</span>=<span class=\"literal\">true</span></span><br><span class=\"line\"><span class=\"attr\">ENABLE_FAST_TRAVEL</span>=<span class=\"literal\">true</span></span><br><span class=\"line\"><span class=\"attr\">IS_START_LOCATION_SELECT_BY_MAP</span>=<span class=\"literal\">true</span></span><br><span class=\"line\"><span class=\"attr\">EXIST_PLAYER_AFTER_LOGOUT</span>=<span class=\"literal\">false</span></span><br><span class=\"line\"><span class=\"attr\">ENABLE_DEFENSE_OTHER_GUILD_PLAYER</span>=<span class=\"literal\">false</span></span><br><span class=\"line\"><span class=\"attr\">COOP_PLAYER_MAX_NUM</span>=<span class=\"number\">4</span></span><br><span class=\"line\"><span class=\"attr\">MAX_PLAYERS</span>=<span class=\"number\">32</span></span><br><span class=\"line\"><span class=\"attr\">SERVER_NAME</span>=jammsen-docker-generated-<span class=\"comment\">###RANDOM###</span></span><br><span class=\"line\"><span class=\"attr\">SERVER_DESCRIPTION</span>=Palworld-Dedicated-Server running in Docker by jammsen</span><br><span class=\"line\"><span class=\"attr\">ADMIN_PASSWORD</span>=adminPasswordHere</span><br><span class=\"line\"><span class=\"attr\">SERVER_PASSWORD</span>=serverPasswordHere</span><br><span class=\"line\"><span class=\"attr\">PUBLIC_PORT</span>=<span class=\"number\">8211</span></span><br><span class=\"line\"><span class=\"attr\">PUBLIC_IP</span>=</span><br><span class=\"line\"><span class=\"attr\">RCON_ENABLED</span>=<span class=\"literal\">true</span></span><br><span class=\"line\"><span class=\"attr\">RCON_PORT</span>=<span class=\"number\">25575</span></span><br><span class=\"line\"><span class=\"attr\">REGION</span>=</span><br><span class=\"line\"><span class=\"attr\">USEAUTH</span>=<span class=\"literal\">true</span></span><br><span class=\"line\"><span class=\"attr\">BAN_LIST_URL</span>=https://api.palworldgame.com/api/banlist.txt</span><br><span class=\"line\"><span class=\"attr\">SHOW_PLAYER_LIST</span>=<span class=\"literal\">false</span></span><br></pre></td></tr></table></figure>\n<p>再创建一个空的 game 目录。</p>\n<p>此时，再次执行命令： <code>docker compose up -d &amp;&amp; docker compose logs -f </code></p>\n<p>观察一下当前日志，初次启动会下载服务端文件比较耗时。</p>\n<p>当看到这样的内容出来，就说启动成功</p>\n<p><img src=\"https://gcore.jsdelivr.net/gh/antengye/picgo-db/hexo/202402291438622.png\" alt=\"帕鲁服务端启动完成\"></p>\n<p>可以按 ctrl+c 结束日志查看。</p>\n<p>完整目录结构如下</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">- server</span><br><span class=\"line\">  - docker-compose.yml</span><br><span class=\"line\">  - default.env</span><br><span class=\"line\">  - game</span><br></pre></td></tr></table></figure>\n<p><code>docker compose</code>  相关命令都需要在 <code>server</code>  目录下执行</p>\n<h3 id=\"云服务器策略放行\"><a class=\"markdownIt-Anchor\" href=\"#云服务器策略放行\">#</a> 云服务器策略放行</h3>\n<p>如果你是用云服务器，记得要在控制台的安全组上添加</p>\n<p>8211(<strong>UDP</strong>) 和 25575 (<strong>TCP</strong>)</p>\n<p>两条规则。<strong>注意协议！！！</strong></p>\n<p>附阿里云的添加方法：</p>\n<p><img src=\"https://help-static-aliyun-doc.aliyuncs.com/assets/img/zh-CN/7096051661/p128550.gif\" alt=\"添加安全组规则\"></p>\n<p>附腾讯云的添加方法：</p>\n<p><a href=\"https://cloud.tencent.com/document/product/213/39740\">https://cloud.tencent.com/document/product/213/39740</a></p>\n<p>来源选： <code>IP 地址或 CIDR 段 </code>  填： <code>0.0.0.0/0</code></p>\n<p>协议端口：</p>\n<p>UDP:8211</p>\n<p>TCP:25575</p>\n<p>以上步骤做完，就可以输入 <code>服务器IP:8211</code>  访问这个属于自己服务器了。</p>\n<p><img src=\"https://tech.palworldgame.com/assets/images/connect-1c10ce87f46b3bdad1b46be1b25f0807.jpg\" alt=\"connect\"></p>\n<p>关服命令： <code>docker compose down</code></p>\n<h2 id=\"服务端管理\"><a class=\"markdownIt-Anchor\" href=\"#服务端管理\">#</a> 服务端管理</h2>\n<p>作为腐竹，想要在服务器出现问题时能够快速处理，就需要了解以下几个基础的知识点。</p>\n<p>以下就拿刚刚部署好的 <code>docker-compose.yml</code>  来逐行说明</p>\n<h3 id=\"基础信息\"><a class=\"markdownIt-Anchor\" href=\"#基础信息\">#</a> 基础信息</h3>\n<figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attr\">version:</span> <span class=\"string\">&#x27;3.9&#x27;</span></span><br><span class=\"line\"><span class=\"attr\">services:</span></span><br><span class=\"line\">  <span class=\"attr\">palworld-dedicated-server:</span></span><br><span class=\"line\">    <span class=\"attr\">container_name:</span> <span class=\"string\">palworld-dedicated-server</span></span><br><span class=\"line\">    <span class=\"attr\">image:</span> <span class=\"string\">jammsen/palworld-dedicated-server:latest</span></span><br><span class=\"line\">    <span class=\"attr\">restart:</span> <span class=\"string\">unless-stopped</span></span><br></pre></td></tr></table></figure>\n<ul>\n<li>\n<p>version：声明这个文件适用的 docker-compose 的版本</p>\n</li>\n<li>\n<p>services: 创建的服务</p>\n</li>\n<li>\n<p>palworld-dedicated-server: 服务名</p>\n</li>\n<li>\n<p>container_name: 该容器的命名，可以自己取。</p>\n</li>\n<li>\n<p>restart：重启策略</p>\n<ul>\n<li>restart: “no” // 不会自动重启</li>\n<li>restart: always // 只要关掉了就会重启</li>\n<li>restart: on-failure // 服务启动失败会重启</li>\n<li>restart: unless-stopped // 除非被手动关闭</li>\n</ul>\n</li>\n<li>\n<p>image：镜像地址</p>\n<ul>\n<li>作为核心。一个将服务端打包好的链接，本次用的是 https://github.com/jammsen/docker-palworld-dedicated-server</li>\n<li>也可以自己制作并打包镜像，这里就不多赘述。</li>\n</ul>\n</li>\n</ul>\n<h3 id=\"端口映射\"><a class=\"markdownIt-Anchor\" href=\"#端口映射\">#</a> 端口映射</h3>\n<figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attr\">ports:</span></span><br><span class=\"line\">  <span class=\"bullet\">-</span> <span class=\"attr\">target:</span> <span class=\"number\">8211</span> <span class=\"comment\"># Gamerserver port inside of the container</span></span><br><span class=\"line\">    <span class=\"attr\">published:</span> <span class=\"number\">8211</span> <span class=\"comment\"># Gamerserver port on your host</span></span><br><span class=\"line\">    <span class=\"attr\">protocol:</span> <span class=\"string\">udp</span></span><br><span class=\"line\">    <span class=\"attr\">mode:</span> <span class=\"string\">host</span></span><br><span class=\"line\">  <span class=\"bullet\">-</span> <span class=\"attr\">target:</span> <span class=\"number\">25575</span> <span class=\"comment\"># RCON port inside of the container</span></span><br><span class=\"line\">    <span class=\"attr\">published:</span> <span class=\"number\">25575</span> <span class=\"comment\"># RCON port on your host</span></span><br><span class=\"line\">    <span class=\"attr\">protocol:</span> <span class=\"string\">tcp</span></span><br><span class=\"line\">    <span class=\"attr\">mode:</span> <span class=\"string\">host</span></span><br></pre></td></tr></table></figure>\n<ul>\n<li><code>target</code> : 容器自己本身的端口。镜像不变更的情况下不能改这个\n<ul>\n<li>对于帕鲁服务端来说，默认端口开放在 8211，镜像制作也一般选择 8211</li>\n</ul>\n</li>\n<li><code>published</code> : 对外暴露的端口。也就是你在客户端要连接的时候需要输入的端口号。这个可以自己调整</li>\n<li><code>protocol</code> : 端口的协议。一般服务端都是 UDP 协议，网站一般是 TCP 协议。</li>\n<li><code>mode</code> : 网络模式，有 <code>host</code>  、 <code>bridge</code> 、  <code>none</code>  等这里就不展开了。要深入了解的可以查看文档：<a href=\"https://docs.docker.com/network/drivers/\">https://docs.docker.com/network/drivers/</a></li>\n</ul>\n<h3 id=\"目录映射\"><a class=\"markdownIt-Anchor\" href=\"#目录映射\">#</a> 目录映射</h3>\n<pre><code>env_file:\n  - ./default.env\nvolumes:\n  - ./game:/palworld\n</code></pre>\n<ul>\n<li><code>env_file</code> : 从文件中读取配置作为服务启动后的<strong>环境变量</strong>。</li>\n<li><code>volumes</code> : 挂载文件\n<ul>\n<li>由于 Docker 的便利性，所以在没有挂载文件时，在关闭 docker 服务后，服务中的所有数据都将不复存在（主打一个片叶不沾身）</li>\n<li>因此，为了保存我们的服务端数据，需要将游戏的文件存在我们的机器上。</li>\n<li><code>./game:/palworld</code>  的意思是，将当前目录下的 game 目录挂载到容器中的 /palworld 目录下。（通俗的说就是 game 目录此时等同于 palword 目录）</li>\n<li>此时，docker 服务里面产生游戏数据都会存到 /palworld 目录下，我们也就可以通过 game 目录访问到游戏数据了</li>\n<li>在游戏启动完成后，你可以 cd 到 game 目录下查看是否已经有了游戏文件了</li>\n<li><img src=\"https://gcore.jsdelivr.net/gh/antengye/picgo-db/hexo/202402292131502.png\" alt=\"游戏目录的文件\"></li>\n</ul>\n</li>\n</ul>\n<p>有了这个目录映射后，想要对游戏的配置进行手动变更、对存档进行修改、恢复存档，都可以通过 game 目录来进行操作。</p>\n<p>比如查看服务端配置文件：Pal\\Saved\\Config\\LinuxServer\\PalWorldSettings.ini</p>\n<h3 id=\"资源使用情况\"><a class=\"markdownIt-Anchor\" href=\"#资源使用情况\">#</a> 资源使用情况</h3>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">docker stats</span><br></pre></td></tr></table></figure>\n<p>通过这个命令，可以查看到帕鲁服务占用的资源，如果占用异常了，就及时进行重启 <code>docker compose restart</code> 。</p>\n<p>如下图第一个就是帕鲁服务器的资源占用情况。这还是已经配置了自动重启后的。<br>\n<img src=\"https://gcore.jsdelivr.net/gh/antengye/picgo-db/hexo/202402281502468.png\" alt=\"帕鲁服务资源占用\"></p>\n<h2 id=\"总结\"><a class=\"markdownIt-Anchor\" href=\"#总结\">#</a> 总结</h2>\n<p>以上就是帮助各位成为一名合格的监督帕鲁的服主的教程，当然还有很多细节没有介绍到。</p>\n<p>如果有需要，那就另外开坑细讲了。</p>\n",
            "tags": [
                "Docker",
                "game"
            ]
        },
        {
            "id": "https://bigorange.work/p/22f71dfd/",
            "url": "https://bigorange.work/p/22f71dfd/",
            "title": "Tailscale组网记录",
            "date_published": "2024-02-02T09:18:31.000Z",
            "content_html": "<h2 id=\"tailscale介绍\"><a class=\"markdownIt-Anchor\" href=\"#tailscale介绍\">#</a> Tailscale 介绍</h2>\n<p>主要用于内网穿透</p>\n<p>Tailscale 是在用户态实现了 WireGuard 协议，而 Netmaker 直接使用了内核态的 WireGuard.</p>\n<p><a href=\"https://github.com/tailscale/tailscale\">GitHub - tailscale/tailscale: The easiest, most secure way to use WireGuard and 2FA.</a></p>\n<p>当然，还有 zerotier 更加简单的产品。</p>\n<h2 id=\"搭建使用\"><a class=\"markdownIt-Anchor\" href=\"#搭建使用\">#</a> 搭建 &amp; 使用</h2>\n<p>由于 Tailscale 的服务端是商业产品。所以改用 Headscale 作为服务端开源替代品。（客户端还是 tailscale）</p>\n<h3 id=\"安装headscale\"><a class=\"markdownIt-Anchor\" href=\"#安装headscale\">#</a> 安装 Headscale</h3>\n<p><a href=\"https://github.com/juanfont/headscale\">https://github.com/juanfont/headscale</a></p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 下载github的release 解压</span></span><br><span class=\"line\"><span class=\"built_in\">mv</span> headscale /usr/local/bin/headscale</span><br><span class=\"line\"><span class=\"built_in\">chmod</span> +x /usr/local/bin/headscale</span><br><span class=\"line\"><span class=\"built_in\">mkdir</span> -p /etc/headscale</span><br><span class=\"line\"><span class=\"built_in\">mkdir</span> -p /var/lib/headscale</span><br><span class=\"line\"><span class=\"built_in\">touch</span> /var/lib/headscale/db.sqlite</span><br><span class=\"line\">wget https://github.com/juanfont/headscale/raw/main/config-example.yaml -O /etc/headscale/config.yaml</span><br><span class=\"line\">useradd headscale -d /home/headscale -m</span><br><span class=\"line\"><span class=\"built_in\">chown</span> -R headscale:headscale /var/lib/headscale</span><br></pre></td></tr></table></figure>\n<h3 id=\"修改服务端配置\"><a class=\"markdownIt-Anchor\" href=\"#修改服务端配置\">#</a> 修改服务端配置</h3>\n<p>主要关注 <code>server_url</code>  和 <code>ip_prefixes</code>  部分即可。</p>\n<p>以下为参考。</p>\n<p><code>vim /etc/headscale/config.yaml</code></p>\n<figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br><span class=\"line\">105</span><br><span class=\"line\">106</span><br><span class=\"line\">107</span><br><span class=\"line\">108</span><br><span class=\"line\">109</span><br><span class=\"line\">110</span><br><span class=\"line\">111</span><br><span class=\"line\">112</span><br><span class=\"line\">113</span><br><span class=\"line\">114</span><br><span class=\"line\">115</span><br><span class=\"line\">116</span><br><span class=\"line\">117</span><br><span class=\"line\">118</span><br><span class=\"line\">119</span><br><span class=\"line\">120</span><br><span class=\"line\">121</span><br><span class=\"line\">122</span><br><span class=\"line\">123</span><br><span class=\"line\">124</span><br><span class=\"line\">125</span><br><span class=\"line\">126</span><br><span class=\"line\">127</span><br><span class=\"line\">128</span><br><span class=\"line\">129</span><br><span class=\"line\">130</span><br><span class=\"line\">131</span><br><span class=\"line\">132</span><br><span class=\"line\">133</span><br><span class=\"line\">134</span><br><span class=\"line\">135</span><br><span class=\"line\">136</span><br><span class=\"line\">137</span><br><span class=\"line\">138</span><br><span class=\"line\">139</span><br><span class=\"line\">140</span><br><span class=\"line\">141</span><br><span class=\"line\">142</span><br><span class=\"line\">143</span><br><span class=\"line\">144</span><br><span class=\"line\">145</span><br><span class=\"line\">146</span><br><span class=\"line\">147</span><br><span class=\"line\">148</span><br><span class=\"line\">149</span><br><span class=\"line\">150</span><br><span class=\"line\">151</span><br><span class=\"line\">152</span><br><span class=\"line\">153</span><br><span class=\"line\">154</span><br><span class=\"line\">155</span><br><span class=\"line\">156</span><br><span class=\"line\">157</span><br><span class=\"line\">158</span><br><span class=\"line\">159</span><br><span class=\"line\">160</span><br><span class=\"line\">161</span><br><span class=\"line\">162</span><br><span class=\"line\">163</span><br><span class=\"line\">164</span><br><span class=\"line\">165</span><br><span class=\"line\">166</span><br><span class=\"line\">167</span><br><span class=\"line\">168</span><br><span class=\"line\">169</span><br><span class=\"line\">170</span><br><span class=\"line\">171</span><br><span class=\"line\">172</span><br><span class=\"line\">173</span><br><span class=\"line\">174</span><br><span class=\"line\">175</span><br><span class=\"line\">176</span><br><span class=\"line\">177</span><br><span class=\"line\">178</span><br><span class=\"line\">179</span><br><span class=\"line\">180</span><br><span class=\"line\">181</span><br><span class=\"line\">182</span><br><span class=\"line\">183</span><br><span class=\"line\">184</span><br><span class=\"line\">185</span><br><span class=\"line\">186</span><br><span class=\"line\">187</span><br><span class=\"line\">188</span><br><span class=\"line\">189</span><br><span class=\"line\">190</span><br><span class=\"line\">191</span><br><span class=\"line\">192</span><br><span class=\"line\">193</span><br><span class=\"line\">194</span><br><span class=\"line\">195</span><br><span class=\"line\">196</span><br><span class=\"line\">197</span><br><span class=\"line\">198</span><br><span class=\"line\">199</span><br><span class=\"line\">200</span><br><span class=\"line\">201</span><br><span class=\"line\">202</span><br><span class=\"line\">203</span><br><span class=\"line\">204</span><br><span class=\"line\">205</span><br><span class=\"line\">206</span><br><span class=\"line\">207</span><br><span class=\"line\">208</span><br><span class=\"line\">209</span><br><span class=\"line\">210</span><br><span class=\"line\">211</span><br><span class=\"line\">212</span><br><span class=\"line\">213</span><br><span class=\"line\">214</span><br><span class=\"line\">215</span><br><span class=\"line\">216</span><br><span class=\"line\">217</span><br><span class=\"line\">218</span><br><span class=\"line\">219</span><br><span class=\"line\">220</span><br><span class=\"line\">221</span><br><span class=\"line\">222</span><br><span class=\"line\">223</span><br><span class=\"line\">224</span><br><span class=\"line\">225</span><br><span class=\"line\">226</span><br><span class=\"line\">227</span><br><span class=\"line\">228</span><br><span class=\"line\">229</span><br><span class=\"line\">230</span><br><span class=\"line\">231</span><br><span class=\"line\">232</span><br><span class=\"line\">233</span><br><span class=\"line\">234</span><br><span class=\"line\">235</span><br><span class=\"line\">236</span><br><span class=\"line\">237</span><br><span class=\"line\">238</span><br><span class=\"line\">239</span><br><span class=\"line\">240</span><br><span class=\"line\">241</span><br><span class=\"line\">242</span><br><span class=\"line\">243</span><br><span class=\"line\">244</span><br><span class=\"line\">245</span><br><span class=\"line\">246</span><br><span class=\"line\">247</span><br><span class=\"line\">248</span><br><span class=\"line\">249</span><br><span class=\"line\">250</span><br><span class=\"line\">251</span><br><span class=\"line\">252</span><br><span class=\"line\">253</span><br><span class=\"line\">254</span><br><span class=\"line\">255</span><br><span class=\"line\">256</span><br><span class=\"line\">257</span><br><span class=\"line\">258</span><br><span class=\"line\">259</span><br><span class=\"line\">260</span><br><span class=\"line\">261</span><br><span class=\"line\">262</span><br><span class=\"line\">263</span><br><span class=\"line\">264</span><br><span class=\"line\">265</span><br><span class=\"line\">266</span><br><span class=\"line\">267</span><br><span class=\"line\">268</span><br><span class=\"line\">269</span><br><span class=\"line\">270</span><br><span class=\"line\">271</span><br><span class=\"line\">272</span><br><span class=\"line\">273</span><br><span class=\"line\">274</span><br><span class=\"line\">275</span><br><span class=\"line\">276</span><br><span class=\"line\">277</span><br><span class=\"line\">278</span><br><span class=\"line\">279</span><br><span class=\"line\">280</span><br><span class=\"line\">281</span><br><span class=\"line\">282</span><br><span class=\"line\">283</span><br><span class=\"line\">284</span><br><span class=\"line\">285</span><br><span class=\"line\">286</span><br><span class=\"line\">287</span><br><span class=\"line\">288</span><br><span class=\"line\">289</span><br><span class=\"line\">290</span><br><span class=\"line\">291</span><br><span class=\"line\">292</span><br><span class=\"line\">293</span><br><span class=\"line\">294</span><br><span class=\"line\">295</span><br><span class=\"line\">296</span><br><span class=\"line\">297</span><br><span class=\"line\">298</span><br><span class=\"line\">299</span><br><span class=\"line\">300</span><br><span class=\"line\">301</span><br><span class=\"line\">302</span><br><span class=\"line\">303</span><br><span class=\"line\">304</span><br><span class=\"line\">305</span><br><span class=\"line\">306</span><br><span class=\"line\">307</span><br><span class=\"line\">308</span><br><span class=\"line\">309</span><br><span class=\"line\">310</span><br><span class=\"line\">311</span><br><span class=\"line\">312</span><br><span class=\"line\">313</span><br><span class=\"line\">314</span><br><span class=\"line\">315</span><br><span class=\"line\">316</span><br><span class=\"line\">317</span><br><span class=\"line\">318</span><br><span class=\"line\">319</span><br><span class=\"line\">320</span><br><span class=\"line\">321</span><br><span class=\"line\">322</span><br><span class=\"line\">323</span><br><span class=\"line\">324</span><br><span class=\"line\">325</span><br><span class=\"line\">326</span><br><span class=\"line\">327</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">---</span></span><br><span class=\"line\"><span class=\"comment\"># headscale will look for a configuration file named `config.yaml` (or `config.json`) in the following order:</span></span><br><span class=\"line\"><span class=\"comment\">#</span></span><br><span class=\"line\"><span class=\"comment\"># - `/etc/headscale`</span></span><br><span class=\"line\"><span class=\"comment\"># - `~/.headscale`</span></span><br><span class=\"line\"><span class=\"comment\"># - current working directory</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># The url clients will connect to.</span></span><br><span class=\"line\"><span class=\"comment\"># Typically this will be a domain like:</span></span><br><span class=\"line\"><span class=\"comment\">#</span></span><br><span class=\"line\"><span class=\"comment\"># https://myheadscale.example.com:443</span></span><br><span class=\"line\"><span class=\"comment\">#</span></span><br><span class=\"line\"><span class=\"attr\">server_url:</span> <span class=\"string\">http://&#123;ip&#125;:8080</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># Address to listen to / bind to on the server</span></span><br><span class=\"line\"><span class=\"comment\">#</span></span><br><span class=\"line\"><span class=\"comment\"># For production:</span></span><br><span class=\"line\"><span class=\"comment\"># listen_addr: 0.0.0.0:8080</span></span><br><span class=\"line\"><span class=\"attr\">listen_addr:</span> <span class=\"number\">0.0</span><span class=\"number\">.0</span><span class=\"number\">.0</span><span class=\"string\">:8080</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># Address to listen to /metrics, you may want</span></span><br><span class=\"line\"><span class=\"comment\"># to keep this endpoint private to your internal</span></span><br><span class=\"line\"><span class=\"comment\"># network</span></span><br><span class=\"line\"><span class=\"comment\">#</span></span><br><span class=\"line\"><span class=\"attr\">metrics_listen_addr:</span> <span class=\"number\">127.0</span><span class=\"number\">.0</span><span class=\"number\">.1</span><span class=\"string\">:9090</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># Address to listen for gRPC.</span></span><br><span class=\"line\"><span class=\"comment\"># gRPC is used for controlling a headscale server</span></span><br><span class=\"line\"><span class=\"comment\"># remotely with the CLI</span></span><br><span class=\"line\"><span class=\"comment\"># <span class=\"doctag\">Note:</span> Remote access _only_ works if you have</span></span><br><span class=\"line\"><span class=\"comment\"># valid certificates.</span></span><br><span class=\"line\"><span class=\"comment\">#</span></span><br><span class=\"line\"><span class=\"comment\"># For production:</span></span><br><span class=\"line\"><span class=\"comment\"># grpc_listen_addr: 0.0.0.0:50443</span></span><br><span class=\"line\"><span class=\"attr\">grpc_listen_addr:</span> <span class=\"number\">0.0</span><span class=\"number\">.0</span><span class=\"number\">.0</span><span class=\"string\">:50443</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># Allow the gRPC admin interface to run in INSECURE</span></span><br><span class=\"line\"><span class=\"comment\"># mode. This is not recommended as the traffic will</span></span><br><span class=\"line\"><span class=\"comment\"># be unencrypted. Only enable if you know what you</span></span><br><span class=\"line\"><span class=\"comment\"># are doing.</span></span><br><span class=\"line\"><span class=\"attr\">grpc_allow_insecure:</span> <span class=\"literal\">false</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># Private key used to encrypt the traffic between headscale</span></span><br><span class=\"line\"><span class=\"comment\"># and Tailscale clients.</span></span><br><span class=\"line\"><span class=\"comment\"># The private key file will be autogenerated if it&#x27;s missing.</span></span><br><span class=\"line\"><span class=\"comment\">#</span></span><br><span class=\"line\"><span class=\"attr\">private_key_path:</span> <span class=\"string\">/var/lib/headscale/private.key</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># The Noise section includes specific configuration for the</span></span><br><span class=\"line\"><span class=\"comment\"># TS2021 Noise protocol</span></span><br><span class=\"line\"><span class=\"attr\">noise:</span></span><br><span class=\"line\">  <span class=\"comment\"># The Noise private key is used to encrypt the</span></span><br><span class=\"line\">  <span class=\"comment\"># traffic between headscale and Tailscale clients when</span></span><br><span class=\"line\">  <span class=\"comment\"># using the new Noise-based protocol. It must be different</span></span><br><span class=\"line\">  <span class=\"comment\"># from the legacy private key.</span></span><br><span class=\"line\">  <span class=\"attr\">private_key_path:</span> <span class=\"string\">/var/lib/headscale/noise_private.key</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># List of IP prefixes to allocate tailaddresses from.</span></span><br><span class=\"line\"><span class=\"comment\"># Each prefix consists of either an IPv4 or IPv6 address,</span></span><br><span class=\"line\"><span class=\"comment\"># and the associated prefix length, delimited by a slash.</span></span><br><span class=\"line\"><span class=\"comment\"># It must be within IP ranges supported by the Tailscale</span></span><br><span class=\"line\"><span class=\"comment\"># client - i.e., subnets of 100.64.0.0/10 and fd7a:115c:a1e0::/48.</span></span><br><span class=\"line\"><span class=\"comment\"># See below:</span></span><br><span class=\"line\"><span class=\"comment\"># IPv6: https://github.com/tailscale/tailscale/blob/22ebb25e833264f58d7c3f534a8b166894a89536/net/tsaddr/tsaddr.go#LL81C52-L81C71</span></span><br><span class=\"line\"><span class=\"comment\"># IPv4: https://github.com/tailscale/tailscale/blob/22ebb25e833264f58d7c3f534a8b166894a89536/net/tsaddr/tsaddr.go#L33</span></span><br><span class=\"line\"><span class=\"comment\"># Any other range is NOT supported, and it will cause unexpected issues.</span></span><br><span class=\"line\"><span class=\"attr\">ip_prefixes:</span></span><br><span class=\"line\">  <span class=\"comment\">#- fd7a:115c:a1e0::/48</span></span><br><span class=\"line\">  <span class=\"bullet\">-</span> <span class=\"number\">100.64</span><span class=\"number\">.0</span><span class=\"number\">.0</span><span class=\"string\">/10</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># DERP is a relay system that Tailscale uses when a direct</span></span><br><span class=\"line\"><span class=\"comment\"># connection cannot be established.</span></span><br><span class=\"line\"><span class=\"comment\"># https://tailscale.com/blog/how-tailscale-works/#encrypted-tcp-relays-derp</span></span><br><span class=\"line\"><span class=\"comment\">#</span></span><br><span class=\"line\"><span class=\"comment\"># headscale needs a list of DERP servers that can be presented</span></span><br><span class=\"line\"><span class=\"comment\"># to the clients.</span></span><br><span class=\"line\"><span class=\"attr\">derp:</span></span><br><span class=\"line\">  <span class=\"attr\">server:</span></span><br><span class=\"line\">    <span class=\"comment\"># If enabled, runs the embedded DERP server and merges it into the rest of the DERP config</span></span><br><span class=\"line\">    <span class=\"comment\"># The Headscale server_url defined above MUST be using https, DERP requires TLS to be in place</span></span><br><span class=\"line\">    <span class=\"attr\">enabled:</span> <span class=\"literal\">false</span></span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\"># Region ID to use for the embedded DERP server.</span></span><br><span class=\"line\">    <span class=\"comment\"># The local DERP prevails if the region ID collides with other region ID coming from</span></span><br><span class=\"line\">    <span class=\"comment\"># the regular DERP config.</span></span><br><span class=\"line\">    <span class=\"attr\">region_id:</span> <span class=\"number\">999</span></span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\"># Region code and name are displayed in the Tailscale UI to identify a DERP region</span></span><br><span class=\"line\">    <span class=\"attr\">region_code:</span> <span class=\"string\">&quot;headscale&quot;</span></span><br><span class=\"line\">    <span class=\"attr\">region_name:</span> <span class=\"string\">&quot;Headscale Embedded DERP&quot;</span></span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\"># Listens over UDP at the configured address for STUN connections - to help with NAT traversal.</span></span><br><span class=\"line\">    <span class=\"comment\"># When the embedded DERP server is enabled stun_listen_addr MUST be defined.</span></span><br><span class=\"line\">    <span class=\"comment\">#</span></span><br><span class=\"line\">    <span class=\"comment\"># For more details on how this works, check this great article: https://tailscale.com/blog/how-tailscale-works/</span></span><br><span class=\"line\">    <span class=\"attr\">stun_listen_addr:</span> <span class=\"string\">&quot;0.0.0.0:3478&quot;</span></span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"comment\"># List of externally available DERP maps encoded in JSON</span></span><br><span class=\"line\">  <span class=\"attr\">urls:</span></span><br><span class=\"line\">    <span class=\"bullet\">-</span> <span class=\"string\">https://controlplane.tailscale.com/derpmap/default</span></span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"comment\"># Locally available DERP map files encoded in YAML</span></span><br><span class=\"line\">  <span class=\"comment\">#</span></span><br><span class=\"line\">  <span class=\"comment\"># This option is mostly interesting for people hosting</span></span><br><span class=\"line\">  <span class=\"comment\"># their own DERP servers:</span></span><br><span class=\"line\">  <span class=\"comment\"># https://tailscale.com/kb/1118/custom-derp-servers/</span></span><br><span class=\"line\">  <span class=\"comment\">#</span></span><br><span class=\"line\">  <span class=\"comment\"># paths:</span></span><br><span class=\"line\">  <span class=\"comment\">#   - /etc/headscale/derp-example.yaml</span></span><br><span class=\"line\">  <span class=\"attr\">paths:</span> []</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"comment\"># If enabled, a worker will be set up to periodically</span></span><br><span class=\"line\">  <span class=\"comment\"># refresh the given sources and update the derpmap</span></span><br><span class=\"line\">  <span class=\"comment\"># will be set up.</span></span><br><span class=\"line\">  <span class=\"attr\">auto_update_enabled:</span> <span class=\"literal\">true</span></span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"comment\"># How often should we check for DERP updates?</span></span><br><span class=\"line\">  <span class=\"attr\">update_frequency:</span> <span class=\"string\">24h</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># Disables the automatic check for headscale updates on startup</span></span><br><span class=\"line\"><span class=\"attr\">disable_check_updates:</span> <span class=\"literal\">true</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># Time before an inactive ephemeral node is deleted?</span></span><br><span class=\"line\"><span class=\"attr\">ephemeral_node_inactivity_timeout:</span> <span class=\"string\">30m</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># Period to check for node updates within the tailnet. A value too low will severely affect</span></span><br><span class=\"line\"><span class=\"comment\"># CPU consumption of Headscale. A value too high (over 60s) will cause problems</span></span><br><span class=\"line\"><span class=\"comment\"># for the nodes, as they won&#x27;t get updates or keep alive messages frequently enough.</span></span><br><span class=\"line\"><span class=\"comment\"># In case of doubts, do not touch the default 10s.</span></span><br><span class=\"line\"><span class=\"attr\">node_update_check_interval:</span> <span class=\"string\">10s</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># SQLite config</span></span><br><span class=\"line\"><span class=\"attr\">db_type:</span> <span class=\"string\">sqlite3</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># For production:</span></span><br><span class=\"line\"><span class=\"attr\">db_path:</span> <span class=\"string\">/var/lib/headscale/db.sqlite</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># # Postgres config</span></span><br><span class=\"line\"><span class=\"comment\"># If using a Unix socket to connect to Postgres, set the socket path in the &#x27;host&#x27; field and leave &#x27;port&#x27; blank.</span></span><br><span class=\"line\"><span class=\"comment\"># db_type: postgres</span></span><br><span class=\"line\"><span class=\"comment\"># db_host: localhost</span></span><br><span class=\"line\"><span class=\"comment\"># db_port: 5432</span></span><br><span class=\"line\"><span class=\"comment\"># db_name: headscale</span></span><br><span class=\"line\"><span class=\"comment\"># db_user: foo</span></span><br><span class=\"line\"><span class=\"comment\"># db_pass: bar</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># If other &#x27;sslmode&#x27; is required instead of &#x27;require(true)&#x27; and &#x27;disabled(false)&#x27;, set the &#x27;sslmode&#x27; you need</span></span><br><span class=\"line\"><span class=\"comment\"># in the &#x27;db_ssl&#x27; field. Refers to https://www.postgresql.org/docs/current/libpq-ssl.html Table 34.1.</span></span><br><span class=\"line\"><span class=\"comment\"># db_ssl: false</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">### TLS configuration</span></span><br><span class=\"line\"><span class=\"comment\">#</span></span><br><span class=\"line\"><span class=\"comment\">## Let&#x27;s encrypt / ACME</span></span><br><span class=\"line\"><span class=\"comment\">#</span></span><br><span class=\"line\"><span class=\"comment\"># headscale supports automatically requesting and setting up</span></span><br><span class=\"line\"><span class=\"comment\"># TLS for a domain with Let&#x27;s Encrypt.</span></span><br><span class=\"line\"><span class=\"comment\">#</span></span><br><span class=\"line\"><span class=\"comment\"># URL to ACME directory</span></span><br><span class=\"line\"><span class=\"attr\">acme_url:</span> <span class=\"string\">https://acme-v02.api.letsencrypt.org/directory</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># Email to register with ACME provider</span></span><br><span class=\"line\"><span class=\"attr\">acme_email:</span> <span class=\"string\">&quot;&quot;</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># Domain name to request a TLS certificate for:</span></span><br><span class=\"line\"><span class=\"attr\">tls_letsencrypt_hostname:</span> <span class=\"string\">&quot;&quot;</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># Path to store certificates and metadata needed by</span></span><br><span class=\"line\"><span class=\"comment\"># letsencrypt</span></span><br><span class=\"line\"><span class=\"comment\"># For production:</span></span><br><span class=\"line\"><span class=\"attr\">tls_letsencrypt_cache_dir:</span> <span class=\"string\">/var/lib/headscale/cache</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># Type of ACME challenge to use, currently supported types:</span></span><br><span class=\"line\"><span class=\"comment\"># HTTP-01 or TLS-ALPN-01</span></span><br><span class=\"line\"><span class=\"comment\"># See [docs/tls.md](docs/tls.md) for more information</span></span><br><span class=\"line\"><span class=\"attr\">tls_letsencrypt_challenge_type:</span> <span class=\"string\">HTTP-01</span></span><br><span class=\"line\"><span class=\"comment\"># When HTTP-01 challenge is chosen, letsencrypt must set up a</span></span><br><span class=\"line\"><span class=\"comment\"># verification endpoint, and it will be listening on:</span></span><br><span class=\"line\"><span class=\"comment\"># :http = port 80</span></span><br><span class=\"line\"><span class=\"attr\">tls_letsencrypt_listen:</span> <span class=\"string\">&quot;:http&quot;</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">## Use already defined certificates:</span></span><br><span class=\"line\"><span class=\"attr\">tls_cert_path:</span> <span class=\"string\">&quot;&quot;</span></span><br><span class=\"line\"><span class=\"attr\">tls_key_path:</span> <span class=\"string\">&quot;&quot;</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"attr\">log:</span></span><br><span class=\"line\">  <span class=\"comment\"># Output formatting for logs: text or json</span></span><br><span class=\"line\">  <span class=\"attr\">format:</span> <span class=\"string\">text</span></span><br><span class=\"line\">  <span class=\"attr\">level:</span> <span class=\"string\">info</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># Path to a file containg ACL policies.</span></span><br><span class=\"line\"><span class=\"comment\"># ACLs can be defined as YAML or HUJSON.</span></span><br><span class=\"line\"><span class=\"comment\"># https://tailscale.com/kb/1018/acls/</span></span><br><span class=\"line\"><span class=\"attr\">acl_policy_path:</span> <span class=\"string\">&quot;&quot;</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">## DNS</span></span><br><span class=\"line\"><span class=\"comment\">#</span></span><br><span class=\"line\"><span class=\"comment\"># headscale supports Tailscale&#x27;s DNS configuration and MagicDNS.</span></span><br><span class=\"line\"><span class=\"comment\"># Please have a look to their KB to better understand the concepts:</span></span><br><span class=\"line\"><span class=\"comment\">#</span></span><br><span class=\"line\"><span class=\"comment\"># - https://tailscale.com/kb/1054/dns/</span></span><br><span class=\"line\"><span class=\"comment\"># - https://tailscale.com/kb/1081/magicdns/</span></span><br><span class=\"line\"><span class=\"comment\"># - https://tailscale.com/blog/2021-09-private-dns-with-magicdns/</span></span><br><span class=\"line\"><span class=\"comment\">#</span></span><br><span class=\"line\"><span class=\"attr\">dns_config:</span></span><br><span class=\"line\">  <span class=\"comment\"># Whether to prefer using Headscale provided DNS or use local.</span></span><br><span class=\"line\">  <span class=\"attr\">override_local_dns:</span> <span class=\"literal\">true</span></span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"comment\"># List of DNS servers to expose to clients.</span></span><br><span class=\"line\">  <span class=\"attr\">nameservers:</span></span><br><span class=\"line\">    <span class=\"bullet\">-</span> <span class=\"number\">223.5</span><span class=\"number\">.5</span><span class=\"number\">.5</span></span><br><span class=\"line\">    <span class=\"bullet\">-</span> <span class=\"number\">8.8</span><span class=\"number\">.8</span><span class=\"number\">.8</span></span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"comment\"># NextDNS (see https://tailscale.com/kb/1218/nextdns/).</span></span><br><span class=\"line\">  <span class=\"comment\"># &quot;abc123&quot; is example NextDNS ID, replace with yours.</span></span><br><span class=\"line\">  <span class=\"comment\">#</span></span><br><span class=\"line\">  <span class=\"comment\"># With metadata sharing:</span></span><br><span class=\"line\">  <span class=\"comment\"># nameservers:</span></span><br><span class=\"line\">  <span class=\"comment\">#   - https://dns.nextdns.io/abc123</span></span><br><span class=\"line\">  <span class=\"comment\">#</span></span><br><span class=\"line\">  <span class=\"comment\"># Without metadata sharing:</span></span><br><span class=\"line\">  <span class=\"comment\"># nameservers:</span></span><br><span class=\"line\">  <span class=\"comment\">#   - 2a07:a8c0::ab:c123</span></span><br><span class=\"line\">  <span class=\"comment\">#   - 2a07:a8c1::ab:c123</span></span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"comment\"># Split DNS (see https://tailscale.com/kb/1054/dns/),</span></span><br><span class=\"line\">  <span class=\"comment\"># list of search domains and the DNS to query for each one.</span></span><br><span class=\"line\">  <span class=\"comment\">#</span></span><br><span class=\"line\">  <span class=\"comment\"># restricted_nameservers:</span></span><br><span class=\"line\">  <span class=\"comment\">#   foo.bar.com:</span></span><br><span class=\"line\">  <span class=\"comment\">#     - 1.1.1.1</span></span><br><span class=\"line\">  <span class=\"comment\">#   darp.headscale.net:</span></span><br><span class=\"line\">  <span class=\"comment\">#     - 1.1.1.1</span></span><br><span class=\"line\">  <span class=\"comment\">#     - 8.8.8.8</span></span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"comment\"># Search domains to inject.</span></span><br><span class=\"line\">  <span class=\"attr\">domains:</span> []</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"comment\"># Extra DNS records</span></span><br><span class=\"line\">  <span class=\"comment\"># so far only A-records are supported (on the tailscale side)</span></span><br><span class=\"line\">  <span class=\"comment\"># See https://github.com/juanfont/headscale/blob/main/docs/dns-records.md#Limitations</span></span><br><span class=\"line\">  <span class=\"comment\"># extra_records:</span></span><br><span class=\"line\">  <span class=\"comment\">#   - name: &quot;grafana.myvpn.example.com&quot;</span></span><br><span class=\"line\">  <span class=\"comment\">#     type: &quot;A&quot;</span></span><br><span class=\"line\">  <span class=\"comment\">#     value: &quot;100.64.0.3&quot;</span></span><br><span class=\"line\">  <span class=\"comment\">#</span></span><br><span class=\"line\">  <span class=\"comment\">#   # you can also put it in one line</span></span><br><span class=\"line\">  <span class=\"comment\">#   - &#123; name: &quot;prometheus.myvpn.example.com&quot;, type: &quot;A&quot;, value: &quot;100.64.0.3&quot; &#125;</span></span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"comment\"># Whether to use [MagicDNS](https://tailscale.com/kb/1081/magicdns/).</span></span><br><span class=\"line\">  <span class=\"comment\"># Only works if there is at least a nameserver defined.</span></span><br><span class=\"line\">  <span class=\"attr\">magic_dns:</span> <span class=\"literal\">false</span></span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"comment\"># Defines the base domain to create the hostnames for MagicDNS.</span></span><br><span class=\"line\">  <span class=\"comment\"># `base_domain` must be a FQDNs, without the trailing dot.</span></span><br><span class=\"line\">  <span class=\"comment\"># The FQDN of the hosts will be</span></span><br><span class=\"line\">  <span class=\"comment\"># `hostname.user.base_domain` (e.g., _myhost.myuser.example.com_).</span></span><br><span class=\"line\">  <span class=\"attr\">base_domain:</span> <span class=\"string\">example.com</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># Unix socket used for the CLI to connect without authentication</span></span><br><span class=\"line\"><span class=\"comment\"># <span class=\"doctag\">Note:</span> for production you will want to set this to something like:</span></span><br><span class=\"line\"><span class=\"attr\">unix_socket:</span> <span class=\"string\">/var/run/headscale/headscale.sock</span></span><br><span class=\"line\"><span class=\"attr\">unix_socket_permission:</span> <span class=\"string\">&quot;0770&quot;</span></span><br><span class=\"line\"><span class=\"comment\">#</span></span><br><span class=\"line\"><span class=\"comment\"># headscale supports experimental OpenID connect support,</span></span><br><span class=\"line\"><span class=\"comment\"># it is still being tested and might have some bugs, please</span></span><br><span class=\"line\"><span class=\"comment\"># help us test it.</span></span><br><span class=\"line\"><span class=\"comment\"># OpenID Connect</span></span><br><span class=\"line\"><span class=\"comment\"># oidc:</span></span><br><span class=\"line\"><span class=\"comment\">#   only_start_if_oidc_is_available: true</span></span><br><span class=\"line\"><span class=\"comment\">#   issuer: &quot;https://your-oidc.issuer.com/path&quot;</span></span><br><span class=\"line\"><span class=\"comment\">#   client_id: &quot;your-oidc-client-id&quot;</span></span><br><span class=\"line\"><span class=\"comment\">#   client_secret: &quot;your-oidc-client-secret&quot;</span></span><br><span class=\"line\"><span class=\"comment\">#   # Alternatively, set `client_secret_path` to read the secret from the file.</span></span><br><span class=\"line\"><span class=\"comment\">#   # It resolves environment variables, making integration to systemd&#x27;s</span></span><br><span class=\"line\"><span class=\"comment\">#   # `LoadCredential` straightforward:</span></span><br><span class=\"line\"><span class=\"comment\">#   client_secret_path: &quot;$&#123;CREDENTIALS_DIRECTORY&#125;/oidc_client_secret&quot;</span></span><br><span class=\"line\"><span class=\"comment\">#   # client_secret and client_secret_path are mutually exclusive.</span></span><br><span class=\"line\"><span class=\"comment\">#</span></span><br><span class=\"line\"><span class=\"comment\">#   # The amount of time from a node is authenticated with OpenID until it</span></span><br><span class=\"line\"><span class=\"comment\">#   # expires and needs to reauthenticate.</span></span><br><span class=\"line\"><span class=\"comment\">#   # Setting the value to &quot;0&quot; will mean no expiry.</span></span><br><span class=\"line\"><span class=\"comment\">#   expiry: 180d</span></span><br><span class=\"line\"><span class=\"comment\">#</span></span><br><span class=\"line\"><span class=\"comment\">#   # Use the expiry from the token received from OpenID when the user logged</span></span><br><span class=\"line\"><span class=\"comment\">#   # in, this will typically lead to frequent need to reauthenticate and should</span></span><br><span class=\"line\"><span class=\"comment\">#   # only been enabled if you know what you are doing.</span></span><br><span class=\"line\"><span class=\"comment\">#   # <span class=\"doctag\">Note:</span> enabling this will cause `oidc.expiry` to be ignored.</span></span><br><span class=\"line\"><span class=\"comment\">#   use_expiry_from_token: false</span></span><br><span class=\"line\"><span class=\"comment\">#</span></span><br><span class=\"line\"><span class=\"comment\">#   # Customize the scopes used in the OIDC flow, defaults to &quot;openid&quot;, &quot;profile&quot; and &quot;email&quot; and add custom query</span></span><br><span class=\"line\"><span class=\"comment\">#   # parameters to the Authorize Endpoint request. Scopes default to &quot;openid&quot;, &quot;profile&quot; and &quot;email&quot;.</span></span><br><span class=\"line\"><span class=\"comment\">#</span></span><br><span class=\"line\"><span class=\"comment\">#   scope: [&quot;openid&quot;, &quot;profile&quot;, &quot;email&quot;, &quot;custom&quot;]</span></span><br><span class=\"line\"><span class=\"comment\">#   extra_params:</span></span><br><span class=\"line\"><span class=\"comment\">#     domain_hint: example.com</span></span><br><span class=\"line\"><span class=\"comment\">#</span></span><br><span class=\"line\"><span class=\"comment\">#   # List allowed principal domains and/or users. If an authenticated user&#x27;s domain is not in this list, the</span></span><br><span class=\"line\"><span class=\"comment\">#   # authentication request will be rejected.</span></span><br><span class=\"line\"><span class=\"comment\">#</span></span><br><span class=\"line\"><span class=\"comment\">#   allowed_domains:</span></span><br><span class=\"line\"><span class=\"comment\">#     - example.com</span></span><br><span class=\"line\"><span class=\"comment\">#   # <span class=\"doctag\">Note:</span> Groups from keycloak have a leading &#x27;/&#x27;</span></span><br><span class=\"line\"><span class=\"comment\">#   allowed_groups:</span></span><br><span class=\"line\"><span class=\"comment\">#     - /headscale</span></span><br><span class=\"line\"><span class=\"comment\">#   allowed_users:</span></span><br><span class=\"line\"><span class=\"comment\">#     - alice@example.com</span></span><br><span class=\"line\"><span class=\"comment\">#</span></span><br><span class=\"line\"><span class=\"comment\">#   # If `strip_email_domain` is set to `true`, the domain part of the username email address will be removed.</span></span><br><span class=\"line\"><span class=\"comment\">#   # This will transform `first-name.last-name@example.com` to the user `first-name.last-name`</span></span><br><span class=\"line\"><span class=\"comment\">#   # If `strip_email_domain` is set to `false` the domain part will NOT be removed resulting to the following</span></span><br><span class=\"line\"><span class=\"comment\">#   user: `first-name.last-name.example.com`</span></span><br><span class=\"line\"><span class=\"comment\">#</span></span><br><span class=\"line\"><span class=\"comment\">#   strip_email_domain: true</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># Logtail configuration</span></span><br><span class=\"line\"><span class=\"comment\"># Logtail is Tailscales logging and auditing infrastructure, it allows the control panel</span></span><br><span class=\"line\"><span class=\"comment\"># to instruct tailscale nodes to log their activity to a remote server.</span></span><br><span class=\"line\"><span class=\"attr\">logtail:</span></span><br><span class=\"line\">  <span class=\"comment\"># Enable logtail for this headscales clients.</span></span><br><span class=\"line\">  <span class=\"comment\"># As there is currently no support for overriding the log server in headscale, this is</span></span><br><span class=\"line\">  <span class=\"comment\"># disabled by default. Enabling this will make your clients send logs to Tailscale Inc.</span></span><br><span class=\"line\">  <span class=\"attr\">enabled:</span> <span class=\"literal\">false</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># Enabling this option makes devices prefer a random port for WireGuard traffic over the</span></span><br><span class=\"line\"><span class=\"comment\"># default static port 41641. This option is intended as a workaround for some buggy</span></span><br><span class=\"line\"><span class=\"comment\"># firewall devices. See https://tailscale.com/kb/1181/firewalls/ for more information.</span></span><br><span class=\"line\"><span class=\"attr\">randomize_client_port:</span> <span class=\"literal\">false</span></span><br></pre></td></tr></table></figure>\n<h3 id=\"启动headscale\"><a class=\"markdownIt-Anchor\" href=\"#启动headscale\">#</a> 启动 Headscale</h3>\n<p>配置成系统服务或者手动启动 <code>/usr/local/bin/headscale serve</code></p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">vim /etc/systemd/system/headscale.service</span><br><span class=\"line\">systemctl daemon-reload</span><br><span class=\"line\">systemctl <span class=\"built_in\">enable</span> --now headscale</span><br><span class=\"line\">systemctl status headscale</span><br></pre></td></tr></table></figure>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[Unit]</span><br><span class=\"line\">Description=headscale controller</span><br><span class=\"line\">After=syslog.target</span><br><span class=\"line\">After=network.target</span><br><span class=\"line\"></span><br><span class=\"line\">[Service]</span><br><span class=\"line\">Type=simple</span><br><span class=\"line\">User=headscale</span><br><span class=\"line\">Group=headscale</span><br><span class=\"line\">ExecStart=/usr/local/bin/headscale serve</span><br><span class=\"line\">Restart=always</span><br><span class=\"line\">RestartSec=5</span><br><span class=\"line\"><span class=\"meta prompt_\"></span></span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">Optional security enhancements</span></span><br><span class=\"line\">NoNewPrivileges=yes</span><br><span class=\"line\">PrivateTmp=yes</span><br><span class=\"line\">ProtectSystem=strict</span><br><span class=\"line\">ProtectHome=yes</span><br><span class=\"line\">ReadWritePaths=/var/lib/headscale /var/run/headscale</span><br><span class=\"line\">AmbientCapabilities=CAP_NET_BIND_SERVICE</span><br><span class=\"line\">RuntimeDirectory=headscale</span><br><span class=\"line\"></span><br><span class=\"line\">[Install]</span><br><span class=\"line\">WantedBy=multi-user.target</span><br></pre></td></tr></table></figure>\n<h3 id=\"安装tailscale客户端\"><a class=\"markdownIt-Anchor\" href=\"#安装tailscale客户端\">#</a> 安装 Tailscale 客户端</h3>\n<h4 id=\"linux\"><a class=\"markdownIt-Anchor\" href=\"#linux\">#</a> Linux</h4>\n<p>官方二进制包</p>\n<p><a href=\"https://pkgs.tailscale.com/stable/#static\">https://pkgs.tailscale.com/stable/#static</a></p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">tar zxvf tailscale_1.22.2_amd64.tgz</span><br><span class=\"line\"><span class=\"built_in\">cp</span> tailscale_1.22.2_amd64/tailscaled /usr/sbin/tailscaled</span><br><span class=\"line\"><span class=\"built_in\">cp</span> tailscale_1.22.2_amd64/tailscale /usr/bin/tailscale</span><br><span class=\"line\"><span class=\"built_in\">cp</span> tailscale_1.22.2_amd64/systemd/tailscaled.service /lib/systemd/system/tailscaled.service</span><br><span class=\"line\"><span class=\"built_in\">cp</span> tailscale_1.22.2_amd64/systemd/tailscaled.defaults /etc/default/tailscaled</span><br></pre></td></tr></table></figure>\n<h4 id=\"openwrt\"><a class=\"markdownIt-Anchor\" href=\"#openwrt\">#</a> Openwrt</h4>\n<p><img src=\"https://gcore.jsdelivr.net/gh/antengye/picgo-db/hexo/202402021736141.png\" alt=\"image\"></p>\n<h4 id=\"windows\"><a class=\"markdownIt-Anchor\" href=\"#windows\">#</a> Windows</h4>\n<p>访问此链接页面</p>\n<p><code>http://&lt;SERVER_IP&gt;:8080/windows</code></p>\n<p><img src=\"https://gcore.jsdelivr.net/gh/antengye/picgo-db/hexo/202402021736586.png\" alt=\"image-win\"></p>\n<p>安装 tailscale 的 windows 包</p>\n<h3 id=\"注册到服务端\"><a class=\"markdownIt-Anchor\" href=\"#注册到服务端\">#</a> 注册到服务端</h3>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">tailscale up --login-server=http://&lt;SERVER_IP&gt;:8080 --accept-routes=<span class=\"literal\">true</span> --accept-dns=<span class=\"literal\">false</span></span><br><span class=\"line\"><span class=\"comment\"># 开通子网路由</span></span><br><span class=\"line\"><span class=\"comment\"># tailscale up --login-server=http://&lt;SERVER_IP&gt;:8080 --advertise-routes=192.168.31.0/24 --accept-routes=true --accept-dns=false</span></span><br></pre></td></tr></table></figure>\n<p>正常连接会出现</p>\n<p><code>[http://xxxxxx:8080/register?key=905cf165204800247fbd33989dbc22be95c987286c45aac303393704](http://xxxxxx:8080/register?key=905cf165204800247fbd33989dbc22be95c987286c45aac303393704)</code></p>\n<p>访问此链接</p>\n<p>将其中的命令复制粘贴到 headscale 所在机器的终端中即可。</p>\n<h3 id=\"nginx-反代域名\"><a class=\"markdownIt-Anchor\" href=\"#nginx-反代域名\">#</a> nginx 反代（域名）</h3>\n<p>此时需要调整 config.yaml</p>\n<p>改为：</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">server_url: https://&lt;YOUR_SERVER_NAME&gt; <span class=\"comment\"># This should be the FQDN at which headscale will be served</span></span><br><span class=\"line\">listen_addr: 0.0.0.0:8080</span><br><span class=\"line\">metrics_listen_addr: 0.0.0.0:9090</span><br><span class=\"line\">tls_cert_path: <span class=\"string\">&quot;&quot;</span></span><br><span class=\"line\">tls_key_path: <span class=\"string\">&quot;&quot;</span></span><br></pre></td></tr></table></figure>\n<p>nginx 配置</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">map <span class=\"variable\">$http_upgrade</span> <span class=\"variable\">$connection_upgrade</span> &#123;</span><br><span class=\"line\">    default      keep-alive;</span><br><span class=\"line\">    <span class=\"string\">&#x27;websocket&#x27;</span>  upgrade;</span><br><span class=\"line\">    <span class=\"string\">&#x27;&#x27;</span>           close;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">server &#123;</span><br><span class=\"line\">    listen 80;</span><br><span class=\"line\">\tlisten [::]:80;</span><br><span class=\"line\"></span><br><span class=\"line\">\tlisten 443      ssl http2;</span><br><span class=\"line\">\tlisten [::]:443 ssl http2;</span><br><span class=\"line\"></span><br><span class=\"line\">    server_name &lt;YOUR_SERVER_NAME&gt;;</span><br><span class=\"line\"></span><br><span class=\"line\">    ssl_certificate &lt;PATH_TO_CERT&gt;;</span><br><span class=\"line\">    ssl_certificate_key &lt;PATH_CERT_KEY&gt;;</span><br><span class=\"line\">    ssl_protocols TLSv1.2 TLSv1.3;</span><br><span class=\"line\"></span><br><span class=\"line\">    location / &#123;</span><br><span class=\"line\">        proxy_pass http://&lt;IP:PORT&gt;;</span><br><span class=\"line\">        proxy_http_version 1.1;</span><br><span class=\"line\">        proxy_set_header Upgrade <span class=\"variable\">$http_upgrade</span>;</span><br><span class=\"line\">        proxy_set_header Connection <span class=\"variable\">$connection_upgrade</span>;</span><br><span class=\"line\">        proxy_set_header Host <span class=\"variable\">$server_name</span>;</span><br><span class=\"line\">        proxy_redirect http:// https://;</span><br><span class=\"line\">        proxy_buffering off;</span><br><span class=\"line\">        proxy_set_header X-Real-IP <span class=\"variable\">$remote_addr</span>;</span><br><span class=\"line\">        proxy_set_header X-Forwarded-For <span class=\"variable\">$proxy_add_x_forwarded_for</span>;</span><br><span class=\"line\">        proxy_set_header X-Forwarded-Proto <span class=\"variable\">$http_x_forwarded_proto</span>;</span><br><span class=\"line\">        add_header Strict-Transport-Security <span class=\"string\">&quot;max-age=15552000; includeSubDomains&quot;</span> always;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h2 id=\"检查连接\"><a class=\"markdownIt-Anchor\" href=\"#检查连接\">#</a> 检查连接</h2>\n<p>上述流程都做完之后，就可以检测各个客户端之间是否正常互通了。</p>\n<p>在客户端上执行命令：</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">tailscale status</span><br></pre></td></tr></table></figure>\n<p>如果是 P2P，则会出现 direct 字样。如下：</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">100.64.0.3      openwrt              user          linux   active; direct 1.1.1.1:9093, tx 360424 rx 1325880</span><br><span class=\"line\">100.64.0.1      root                 user          linux   idle, tx 4025236 rx 2554044</span><br></pre></td></tr></table></figure>\n<p>也可以执行命令来检查网络状态</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">tailscale netcheck</span><br></pre></td></tr></table></figure>\n<p>如下：</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">Report:</span><br><span class=\"line\">        * UDP: <span class=\"literal\">true</span></span><br><span class=\"line\">        * IPv4: <span class=\"built_in\">yes</span>, xxxx:29799</span><br><span class=\"line\">        * IPv6: <span class=\"built_in\">yes</span>, [xxxxx]:52661</span><br><span class=\"line\">        * MappingVariesByDestIP: <span class=\"literal\">false</span></span><br><span class=\"line\">        * HairPinning: <span class=\"literal\">false</span></span><br><span class=\"line\">        * PortMapping:</span><br><span class=\"line\">        * CaptivePortal: <span class=\"literal\">false</span></span><br><span class=\"line\">        * Nearest DERP: Tokyo</span><br><span class=\"line\">        * DERP latency:</span><br><span class=\"line\">                - tok: 113.2ms (Tokyo)</span><br><span class=\"line\">                - sin: 143ms   (Singapore)</span><br><span class=\"line\">                - hkg: 152.7ms (Hong Kong)</span><br></pre></td></tr></table></figure>\n<p>这里会有 DERP 的信息</p>\n<h2 id=\"derp\"><a class=\"markdownIt-Anchor\" href=\"#derp\">#</a> DERP</h2>\n<p>DERP 作为中转站，可以帮助两个节点建立 P2P 连接，tailscale 官方提供了很多 DERP 的节点。</p>\n<p>如果你所在的地方访问这些节点延迟很高，就会出现 P 延迟很高的情况。</p>\n<p>搭建一个私人且延迟低的 DERP 可以有效的改善这个情况。</p>\n<p>当然，DERP 需要额外的服务器去支持，我就暂时没整了</p>\n<h2 id=\"总结\"><a class=\"markdownIt-Anchor\" href=\"#总结\">#</a> 总结</h2>\n<p>以上就是整个 tailscale 的流程了。</p>\n<h2 id=\"tipswindows端口转发\"><a class=\"markdownIt-Anchor\" href=\"#tipswindows端口转发\">#</a> TIPS：Windows 端口转发</h2>\n<p>A、B、C 三台机器。</p>\n<p>A 和 B 两台已经在 tailscale 网络中。</p>\n<p>C 和 B 属于同一局域网。</p>\n<p>此时如果 C 想要访问 A 的目标服务端口，可以如下设置（B 需要开放 ipv4 转发：net.ipv4.ip_forward=1）</p>\n<p><code>ssh -L &#123;本地端口&#125;:&#123;目标的tailscale-ip&#125;:&#123;目标端口&#125; root@&#123;局域网ip&#125;</code></p>\n<h2 id=\"参考文档\"><a class=\"markdownIt-Anchor\" href=\"#参考文档\">#</a> 参考文档</h2>\n<p><a href=\"https://mritd.com/2022/10/19/use-headscale-to-build-a-p2p-network\">Headscale 搭建 P2P 内网穿透</a></p>\n<p><a href=\"https://github.com/juanfont/headscale/blob/main/docs/reverse-proxy.md\">https://github.com/juanfont/headscale/blob/main/docs/reverse-proxy.md</a></p>\n<p><a href=\"https://kiprey.github.io/2023/11/tailscale-derp/\">浅探 Tailscale DERP 中转服务 | Kiprey’s Blog</a></p>\n<p><a href=\"https://arthurchiao.art/blog/how-nat-traversal-works-zh/\">[译] NAT 穿透是如何工作的：技术原理及企业级实践（Tailscale, 2020）</a></p>\n",
            "tags": [
                "内网穿透",
                "tailscale",
                "headscale",
                "network"
            ]
        },
        {
            "id": "https://bigorange.work/p/e1f/",
            "url": "https://bigorange.work/p/e1f/",
            "title": "捣鼓hexo与githubio",
            "date_published": "2024-01-31T10:00:12.000Z",
            "content_html": "<h2 id=\"前言\"><a class=\"markdownIt-Anchor\" href=\"#前言\">#</a> 前言</h2>\n<p>本以为建一个 blog 很简单，毕竟简单了解了一下用的方式，hexo+GitHub 几乎没什么成本嘛。<br>\n看到别人说还要整两天，我还觉得诧异，这有啥难的。<br>\n实际捣鼓到基本能用的程度之后才发现，对不起，是我低估了。</p>\n<h2 id=\"前期准备\"><a class=\"markdownIt-Anchor\" href=\"#前期准备\">#</a> 前期准备</h2>\n<ol>\n<li>网络加速\n<ol>\n<li>不管做什么，有这个会好很多</li>\n<li>后面把自己在这里踩的坑也分享一下</li>\n</ol>\n</li>\n<li>装 git</li>\n<li>装 node.js</li>\n<li>github 创建 2 个仓库（建议）\n<ol>\n<li><img src=\"https://gcore.jsdelivr.net/gh/antengye/picgo-db/hexo/202402011118120.jpg\" alt=\"仓库安排\"></li>\n<li>工作区就是自己写博客的环境，静态区就是用来挂博客文件的。</li>\n<li>考虑可能会在不同地方写博客，所以把工作区也上传到 github 上进行管理。</li>\n<li>静态区的创建参考官方教程：<a href=\"https://pages.github.com/\">https://pages.github.com/</a></li>\n</ol>\n</li>\n</ol>\n<h2 id=\"安装\"><a class=\"markdownIt-Anchor\" href=\"#安装\">#</a> 安装</h2>\n<p>执行命令安装 hexo</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">npm install hexo-cli -g</span><br></pre></td></tr></table></figure>\n<p>找一个空的文件夹（这里作为<strong>本地工作区</strong>）</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">hexo init</span><br><span class=\"line\">npm install</span><br></pre></td></tr></table></figure>\n<p>找到生成出来的 <code>_config.yml</code>  文件，主要先修改下面这几部分。<br>\n对应的就是上面说的静态区。</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">url: https://yourname.github.io/</span><br><span class=\"line\">theme: landscape <span class=\"comment\">#主题</span></span><br><span class=\"line\">deploy:</span><br><span class=\"line\">    <span class=\"built_in\">type</span>: git </span><br><span class=\"line\">    repo: git@github.com:yourname/yourname.github.io.git </span><br><span class=\"line\">    branch: master <span class=\"comment\"># 默认master分支</span></span><br><span class=\"line\">    message: add new blog <span class=\"comment\"># commit备注</span></span><br></pre></td></tr></table></figure>\n<h2 id=\"部署\"><a class=\"markdownIt-Anchor\" href=\"#部署\">#</a> 部署</h2>\n<p>安装自动部署插件</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">npm install hexo-deployer-git --save</span><br></pre></td></tr></table></figure>\n<p>执行命令</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">hexo d -g</span><br></pre></td></tr></table></figure>\n<p>正常情况下，可以等几分钟后访问 <a href=\"https://yourname.github.io/\">https://yourname.github.io/</a> 来看一眼部署成功没。<br>\n如果没有成功：</p>\n<ol>\n<li>检查 github 仓库的 action 流程完成没：<a href=\"https://github.com/yourname/yourname.github.io/deployments/github-pages%E3%80%82\">https://github.com/yourname/yourname.github.io/deployments/github-pages。</a></li>\n<li>如果 action 流程不存在，大概率就是 github 的 pages 部署有问题，瞄一下文档检查一下。<a href=\"https://pages.github.com/\">https://pages.github.com/</a></li>\n</ol>\n<h2 id=\"写文章\"><a class=\"markdownIt-Anchor\" href=\"#写文章\">#</a> 写文章</h2>\n<p>上述成功后，就可以开始写博客了。</p>\n<p><code>hexo new &quot;第一篇文章&quot;</code>  # 新建文章，新建后在 source/_posts 目录下找到对应.md 文件开始写<br>\n <code>hexo s -o</code>  # 启动本地服务预览<br>\n <code>hexo clean &amp;&amp; hexo g &amp;&amp; hexo d</code>  # 清理，生成，部署</p>\n<p>完事。</p>\n<h2 id=\"美化\"><a class=\"markdownIt-Anchor\" href=\"#美化\">#</a> 美化</h2>\n<h3 id=\"主题\"><a class=\"markdownIt-Anchor\" href=\"#主题\">#</a> 主题</h3>\n<p>正常来说，上述流程已经可以满足基本的需求了。</p>\n<p>但是，想要让博客更好看点，就得上主题了。</p>\n<p>我挑选的主题是<a href=\"https://butterfly.js.org/\"> butterfly</a></p>\n<p>教程：<a href=\"https://butterfly.js.org/posts/21cfbf15/\">https://butterfly.js.org/posts/21cfbf15/</a></p>\n<p>还有很多其他主题，这个就看个人喜好了。</p>\n<h3 id=\"图片\"><a class=\"markdownIt-Anchor\" href=\"#图片\">#</a> 图片</h3>\n<p>一篇文章如果没有图片，文章看起来就有些枯燥。</p>\n<p>所以，至少给文章配一个 cover。</p>\n<p>现在 AI 这么多工具，用 AI 来生成一个文章配图不算什么难事。</p>\n<p>我把生成配图的 AI 工具整到了<i class=\"fa-brands fa-discord\" style=\"color: #B197FC;\"></i><a href=\"https://discord.gg/B2b9RdYb\">Discord</a> 中，用起来更加方便一点。</p>\n<p>比如这样：<br>\n<img src=\"https://gcore.jsdelivr.net/gh/antengye/picgo-db/hexo/202402011454144.png\" alt=\"Discord\"></p>\n<p>欢迎进来一起使用：<i class=\"fa-brands fa-discord\" style=\"color: #B197FC;\"></i><a href=\"https://discord.gg/B2b9RdYb\">Discord</a></p>\n<h3 id=\"图床\"><a class=\"markdownIt-Anchor\" href=\"#图床\">#</a> 图床</h3>\n<p>有了图片，但是怎么贴到 markdown 里面是个问题。</p>\n<h4 id=\"hexo本身的静态资源\"><a class=\"markdownIt-Anchor\" href=\"#hexo本身的静态资源\">#</a> hexo 本身的静态资源</h4>\n<p>对于 hexo 来说，你可以在 source 目录下创建 images 目录，里面放置你的图片。<br>\n这样你就可以用 <code>/images/xxx.jpg</code>  来引用图片了。</p>\n<h4 id=\"oss\"><a class=\"markdownIt-Anchor\" href=\"#oss\">#</a> OSS</h4>\n<p>你可以用七牛云、阿里云 OSS、腾讯云 OSS 等来存储图片。</p>\n<h4 id=\"使用\"><a class=\"markdownIt-Anchor\" href=\"#使用\">#</a> 使用</h4>\n<p>在图床上传完图片之后，直接在文章中贴 <code>![](图片地址)</code>  对应图片的地址即可。</p>\n<p>不过拖动图片 + 上传图片 + 复制图片地址的流程会有点麻烦，所以这里推荐工具 <a href=\"https://picgo.github.io/PicGo-Doc/zh/guide/\">picgo</a></p>\n<p>在安装完之后，推荐配置这几个选项<br>\n<img src=\"https://gcore.jsdelivr.net/gh/antengye/picgo-db/hexo/202402011510316.png\" alt=\"\"></p>\n<p>在你配置完图床的信息之后，你只需要 <code>ctrl+c</code>  一下你的图片，再按一下 <code>ctrl+shift+p</code>  即可完成<strong>拖动图片 + 上传图片 + 复制图片地址</strong>这个流程，这时候在文章中粘贴一下就完事了。</p>\n<h2 id=\"自定义域名\"><a class=\"markdownIt-Anchor\" href=\"#自定义域名\">#</a> 自定义域名</h2>\n<p>本来 github 的 pages 本身提供 https://yourname.github.io/ 的域名。</p>\n<p>但是想要变更为自己的域名，就麻烦一点。</p>\n<p><a href=\"http://xn--xxxx-uk1gj6r17c809cn4zb8f0ajkm.com\">比如说配置域名 xxxx.com</a>，随后在域名运营商那里设置 DNS，增加 CNAME 记录:</p>\n<table>\n<thead>\n<tr>\n<th>Type</th>\n<th>Name</th>\n<th>Content</th>\n<th>TTL</th>\n<th>Proxy status</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>CNAME</td>\n<td><a href=\"http://xxxx.com\">xxxx.com</a></td>\n<td><a href=\"http://xxx.github.io\">xxx.github.io</a></td>\n<td>Auto</td>\n<td>DNS only</td>\n</tr>\n</tbody>\n</table>\n<p>除了 CNAME, 也可以配置 A 记录：</p>\n<p>这几个 A 记录可以在这里确认：<a href=\"https://docs.github.com/en/pages/configuring-a-custom-domain-for-your-github-pages-site/managing-a-custom-domain-for-your-github-pages-site\">A 记录</a></p>\n<table>\n<thead>\n<tr>\n<th>Type</th>\n<th>Name</th>\n<th>Content</th>\n<th>TTL</th>\n<th>Proxy status</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>A</td>\n<td><a href=\"http://xxxx.com\">xxxx.com</a></td>\n<td>185.199.108.153</td>\n<td>Auto</td>\n<td>DNS only</td>\n</tr>\n<tr>\n<td>A</td>\n<td><a href=\"http://xxxx.com\">xxxx.com</a></td>\n<td>185.199.109.153</td>\n<td>Auto</td>\n<td>DNS only</td>\n</tr>\n<tr>\n<td>A</td>\n<td><a href=\"http://xxxx.com\">xxxx.com</a></td>\n<td>185.199.110.153</td>\n<td>Auto</td>\n<td>DNS only</td>\n</tr>\n<tr>\n<td>A</td>\n<td><a href=\"http://xxxx.com\">xxxx.com</a></td>\n<td>185.199.111.153</td>\n<td>Auto</td>\n<td>DNS only</td>\n</tr>\n</tbody>\n</table>\n<p>自定义域名是无法直接使用 https，因为 GitHub 服务器上无法配置我们的域名的证书</p>\n<p>现在 GitHub Pages 的初始域名会强制 HTTPS，也会强制 http 跳转 https:</p>\n<blockquote>\n<p>Enforce HTTPS<br>\n— Required for your site because you are using the default domain (<a href=\"http://xxx.github.io\">xxx.github.io</a>)<br>\nHTTPS provides a layer of encryption that prevents others from snooping on or tampering with traffic to your site. When HTTPS is enforced, your site will only be &gt; &gt; served over HTTPS.</p>\n</blockquote>\n<p>所以，想要使用 https 的话，就得继续设置 CAA。<a href=\"https://docs.github.com/en/pages/configuring-a-custom-domain-for-your-github-pages-site/troubleshooting-custom-domains-and-github-pages#https-errors\">原因</a></p>\n<h3 id=\"caa\"><a class=\"markdownIt-Anchor\" href=\"#caa\">#</a> CAA</h3>\n<p>GitHub 使用 <code>letsencrypt</code>  提供的 <code>CAA</code>  证书签名服务：<a href=\"https://letsencrypt.org/docs/caa/\">CAA 说明</a></p>\n<p>配置如下：</p>\n<table>\n<thead>\n<tr>\n<th>Type</th>\n<th>Name</th>\n<th>Content</th>\n<th>TTL</th>\n<th>Proxy status</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>CAA</td>\n<td><a href=\"http://xxxx.com\">xxxx.com</a></td>\n<td>0 issue <a href=\"http://letsencrypt.org\">letsencrypt.org</a></td>\n<td>Auto</td>\n<td>DNS only</td>\n</tr>\n</tbody>\n</table>\n<p>然后等一段时间之后，访问<a href=\"https://github.com/AnTengye/antengye.github.io/settings/pages\"> github-pages</a> 检查这个页面的 DNScheck 是否通过。</p>\n<p><img src=\"https://gcore.jsdelivr.net/gh/antengye/picgo-db/hexo/202402011750256.png\" alt=\"\"></p>\n<p>通过后便可以勾选 Enforce HTTPS 了</p>\n<h2 id=\"结语\"><a class=\"markdownIt-Anchor\" href=\"#结语\">#</a> 结语</h2>\n<p>总的来说，整完这么一套，能把这篇博客发出来，就算是搞一个段落了。</p>\n<p>中间用到的各种工具，得亏平时有一些接触，不然写起来是真的很麻烦。</p>\n<p>后续应该会有更多的文章分享。</p>\n<p><s>如果我勤快且有时间摸鱼的话</s></p>\n<p>写完发布！<br>\n <code>hexo clean</code> <br>\n <code>hexo d -g</code></p>\n",
            "tags": [
                "折腾",
                "Hexo"
            ]
        }
    ]
}